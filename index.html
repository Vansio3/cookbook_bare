<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e1815">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link rel="stylesheet" as="style" onload="this.rel='stylesheet'"
        href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&family=Plus+Jakarta+Sans%3Awght%40400%3B500%3B700%3B800" />
    <title>Cookbook App</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        body {
            font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;
            --checkbox-tick-svg: url('data:image/svg+xml,%3csvg viewBox=%270 0 16 16%27 fill=%27rgb(255,255,255)%27 xmlns=%27http://www.w3.org/2000/svg%27%3e%3cpath d=%27M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z%27/%3e%3c/svg%3e');
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            background-color: #1e1815;
        }

        .page-container {
            flex-grow: 1;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .page {
            display: none;
            flex-direction: column;
            width: 100%;
            flex-grow: 1;
        }

        .page.active {
            display: flex;
        }

        .page-header {
            position: sticky;
            top: 0;
            z-index: 900;
        }

        #page-index .page-header,
        #page-favorites .page-header,
        #page-profile .page-header { 
            background-color: #1e1815;
        }
        
        #page-recipe .page-header,
        #page-create-recipe .page-header,
        #page-schedule .page-header,
        #page-shopping-list .page-header { /* Added shopping list page header */
            background-color: #231610;
        }


        .page-content {
            flex-grow: 1;
            overflow-y: auto;
            /* Adjusted padding-bottom to account for sticky add item bar in shopping list */
        }
        #page-shopping-list .page-content {
             padding-bottom: 140px; /* Base nav bar + shopping list add bar */
        }
        #page-index .page-content, 
        #page-favorites .page-content,
        #page-recipe .page-content,
        #page-create-recipe .page-content,
        #page-schedule .page-content,
        #page-profile .page-content {
            padding-bottom: 90px; /* Original padding for other pages */
        }


        .bottom-nav-bar {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            border-top: 1px solid #40322b;
            background-color: #2e241f;
        }

        .form-checkbox-custom {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            height: 1.25rem;
            width: 1.25rem;
            border-radius: 0.25rem;
            border-width: 2px;
            border-color: #684231;
            background-color: transparent;
            flex-shrink: 0;
        }

        .form-checkbox-custom:checked {
            background-color: #f0560e;
            border-color: #f0560e;
            background-image: var(--checkbox-tick-svg);
            background-repeat: no-repeat;
            background-position: center;
            background-size: 70%;
        }

        .form-checkbox-custom:focus {
            outline: none;
            box-shadow: none;
            border-color: #684231;
        }

        .horizontal-scroll-cards {
            overflow-x: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .horizontal-scroll-cards::-webkit-scrollbar {
            display: none;
        }
        
        .schedule-day-btn.selected { background-color: #40322b; border-radius: 0.5rem; }
        .schedule-day-btn.today:not(.selected) .day-number-span { box-shadow: 0 0 0 2px #f0560e; border-radius: 9999px; padding-left: 0.25rem; padding-right: 0.25rem; padding-top: 0.125rem; padding-bottom: 0.125rem; }
        .schedule-day-btn.today.selected { border: 2px solid #f0560e; }
        .schedule-day-btn.today .day-name-span, .schedule-day-btn.today .day-number-span { color: #f0560e; }
        .schedule-day-btn.selected:not(.today) .day-name-span { color: #d1d5db; }
        .schedule-day-btn.selected:not(.today) .day-number-span { color: #ffffff; }

        /* Shopping list item styles */
        .shopping-item.checked .item-name {
            text-decoration: line-through;
            color: #8a7369; /* A dimmer text color */
        }
        .shopping-item.checked .form-checkbox-custom {
             background-color: #8a7369; /* Dimmer checkbox */
             border-color: #8a7369;
             background-image: var(--checkbox-tick-svg);
        }
    </style>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "%%FIREBASE_API_KEY%%",
            authDomain: "%%FIREBASE_AUTH_DOMAIN%%",
            projectId: "%%FIREBASE_PROJECT_ID%%",
            databaseURL: "%%FIREBASE_DATABASE_URL%%",
            storageBucket: "%%FIREBASE_STORAGE_BUCKET%%",
            messagingSenderId: "%%FIREBASE_MESSAGING_SENDER_ID%%",
            appId: "%%FIREBASE_APP_ID%%",
            measurementId: "%%FIREBASE_MEASUREMENT_ID%%"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database(); 
        const serverTimestamp = firebase.database.ServerValue.TIMESTAMP;

        const CLOUDINARY_CLOUD_NAME = "%%CLOUDINARY_CLOUD_NAME%%";
        const CLOUDINARY_UPLOAD_PRESET = "%%CLOUDINARY_UPLOAD_PRESET%%";
        const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
    </script>
</head>

<body>

    <div class="page-container">
        <!-- Page: Index (Recipes List) -->
        <div id="page-index" class="page bg-[#1e1815] dark group/design-root">
            <div class="page-header">
                <div class="flex items-center p-4 pb-2 justify-between">
                    <h2 class="text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center">
                        Opi's Cookbook</h2>
                    <button id="header-profile-button-index" title="Profile" class="text-white flex size-10 items-center justify-center rounded-full hover:bg-white/10">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24ZM72.28,194.52a64,64,0,0,1,111.44,0,87.65,87.65,0,0,1-111.44,0ZM96,120a32,32,0,1,1,32,32A32,32,0,0,1,96,120Zm97.77,68.38a79.7,79.7,0,0,0-41.49-27.34,48,48,0,1,0-56.56,0,79.7,79.7,0,0,0-41.49,27.34,88,88,0,1,1,139.54,0Z"></path></svg>
                    </button>
                </div>
                <div class="px-4 py-3">
                    <label class="flex flex-col min-w-40 h-12 w-full">
                        <div class="flex w-full flex-1 items-stretch rounded-xl h-full">
                            <div class="text-[#bda89e] flex border-none bg-[#40322b] items-center justify-center pl-4 rounded-l-xl border-r-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path></svg>
                            </div>
                            <input placeholder="Search recipes" id="search-recipe-input" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border-none bg-[#40322b] focus:border-none h-full placeholder:text-[#bda89e] px-4 rounded-l-none border-l-0 pl-2" />
                        </div>
                    </label>
                </div>
            </div>
            <div class="page-content">
                <h2 id="recently-added-heading" class="text-white text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Recently Added</h2>
                <div class="horizontal-scroll-cards flex"><div id="featured-recipes-container" class="flex items-stretch p-4 gap-3"></div></div>
                <h2 id="all-recipes-heading" class="text-white text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">All Recipes</h2>
                <div id="quick-easy-recipes-container" class="grid grid-cols-[repeat(auto-fit,minmax(158px,1fr))] gap-3 p-4"></div>
            </div>
        </div>

        <div id="page-favorites" class="page bg-[#1e1815] dark group/design-root">
            <div class="page-header">
                <div class="flex items-center p-4 pb-2 justify-between">
                     <div class="text-white flex size-10 shrink-0 items-center cursor-pointer" data-action="back"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z"></path></svg></div>
                    <h2 class="text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center">Favorite Recipes</h2>
                     <button id="header-profile-button-favorites" title="Profile" class="text-white flex size-10 items-center justify-center rounded-full hover:bg-white/10">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M128,24A104,104,0,1,0,232,128,104.11,104.11,0,0,0,128,24ZM72.28,194.52a64,64,0,0,1,111.44,0,87.65,87.65,0,0,1-111.44,0ZM96,120a32,32,0,1,1,32,32A32,32,0,0,1,96,120Zm97.77,68.38a79.7,79.7,0,0,0-41.49-27.34,48,48,0,1,0-56.56,0,79.7,79.7,0,0,0-41.49,27.34,88,88,0,1,1,139.54,0Z"></path></svg>
                    </button>
                </div>
                <div class="px-4 py-3">
                    <label class="flex flex-col min-w-40 h-12 w-full">
                        <div class="flex w-full flex-1 items-stretch rounded-xl h-full">
                            <div class="text-[#bda89e] flex border-none bg-[#40322b] items-center justify-center pl-4 rounded-l-xl border-r-0"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"></path></svg></div>
                            <input placeholder="Search favorite recipes" id="search-favorites-input" class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border-none bg-[#40322b] focus:border-none h-full placeholder:text-[#bda89e] px-4 rounded-l-none border-l-0 pl-2" />
                        </div>
                    </label>
                </div>
            </div>
            <div class="page-content"><div id="favorites-recipes-container" class="grid grid-cols-[repeat(auto-fit,minmax(158px,1fr))] gap-3 p-4"></div></div>
        </div>

        <div id="page-recipe" class="page bg-[#231610] dark group/design-root">
            <div class="page-header">
                <div class="flex items-center p-4 pb-2 justify-between">
                    <div class="text-white flex size-12 shrink-0 items-center cursor-pointer" data-action="back"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z"></path></svg></div>
                    <div class="flex items-center justify-end gap-1">
                        <button id="recipe-edit-button" title="Edit Recipe" class="flex h-12 w-12 items-center justify-center rounded-lg text-white hover:bg-white/10"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M227.31,73.37,182.63,28.68a16,16,0,0,0-22.63,0L36.69,152A15.86,15.86,0,0,0,32,163.31V208a16,16,0,0,0,16,16H92.69A15.86,15.86,0,0,0,104,219.31L227.31,96a16,16,0,0,0,0-22.63ZM92.69,208H48V163.31l88-88L180.69,120ZM192,108.68,147.31,64l24-24L216,84.68Z"></path></svg></button>
                        <button id="recipe-bookmark-button" class="flex h-12 w-12 items-center justify-center rounded-lg text-white hover:bg-white/10"><div class="text-white"><svg id="recipe-bookmark-icon" xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M184,32H72A16,16,0,0,0,56,48V224a8,8,0,0,0,12.24,6.78L128,193.43l59.77,37.35A8,8,0,0,0,200,224V48A16,16,0,0,0,184,32Zm0,177.57-51.77-32.35a8,8,0,0,0-8.48,0L72,209.57V48H184Z"></path></svg></div></button>
                    </div>
                </div>
            </div>
            <div class="page-content">
                <div class="@container"><div class="@[480px]:px-4 @[480px]:py-3"><div id="recipe-image" class="w-full bg-center bg-no-repeat bg-cover flex flex-col justify-end overflow-hidden @[480px]:rounded-xl min-h-80"></div></div></div>
                <h1 id="recipe-title" class="text-white text-[22px] font-bold px-4 pb-3 pt-5"></h1>
                <p id="recipe-description" class="text-white text-base px-4 pb-3 pt-1"></p>
                <h3 class="text-white text-lg font-bold px-4 pb-2 pt-4">Ingredients</h3><div id="recipe-ingredients-list" class="px-4"></div>
                <h3 class="text-white text-lg font-bold px-4 pb-2 pt-4">Instructions</h3><div id="recipe-instructions-list" class="px-4"></div>
                <div class="px-4 py-6"><button id="delete-recipe-button" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl">Delete Recipe</button></div>
            </div>
        </div>

        <div id="page-create-recipe" class="page bg-[#231610] dark group/design-root">
            <div class="page-header">
                <div class="flex items-center p-4 pb-2 justify-between">
                    <div class="text-white flex size-12 shrink-0 items-center cursor-pointer" data-action="back-from-create"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"></path></svg></div>
                    <h2 class="text-white text-lg font-bold flex-1 text-center pr-12">New Recipe</h2> 
                </div>
            </div>
            <div class="page-content">
                <div class="flex max-w-[480px] flex-col gap-4 px-4 py-3 mx-auto w-full">
                    <label class="flex flex-col w-full"><p class="text-white text-base font-medium pb-2">Recipe Title</p><input id="create-recipe-title" placeholder="Enter recipe title" class="form-input w-full rounded-xl text-white bg-[#342118] border-[#684231] h-14 p-[15px]" /></label>
                    <label class="flex flex-col w-full"><p class="text-white text-base font-medium pb-2">Description</p><textarea id="create-recipe-description" placeholder="Brief description" class="form-input w-full rounded-xl text-white bg-[#342118] border-[#684231] min-h-24 p-[15px]"></textarea></label>
                    <label class="flex flex-col w-full"><p class="text-white text-base font-medium pb-2">Ingredients (one per line)</p><textarea id="create-recipe-ingredients" placeholder="Flour, 1 cup..." class="form-input w-full rounded-xl text-white bg-[#342118] border-[#684231] min-h-36 p-[15px]"></textarea></label>
                    <label class="flex flex-col w-full"><p class="text-white text-base font-medium pb-2">Instructions (one step per line)</p><textarea id="create-recipe-instructions" placeholder="1. Mix flour..." class="form-input w-full rounded-xl text-white bg-[#342118] border-[#684231] min-h-36 p-[15px]"></textarea></label>
                    <div class="flex gap-4 w-full">
                        <label class="flex flex-col flex-1"><p class="text-white text-base font-medium pb-2">Prep Time</p><input id="create-recipe-prepTime" placeholder="e.g., 15 mins" class="form-input w-full rounded-xl text-white bg-[#342118] border-[#684231] h-14 p-[15px]" /></label>
                        <label class="flex flex-col flex-1"><p class="text-white text-base font-medium pb-2">Cook Time</p><input id="create-recipe-cookTime" placeholder="e.g., 30 mins" class="form-input w-full rounded-xl text-white bg-[#342118] border-[#684231] h-14 p-[15px]" /></label>
                    </div>
                    <label class="flex flex-col w-full"><p class="text-white text-base font-medium pb-2">Servings</p><input id="create-recipe-servings" placeholder="e.g., 4" class="form-input w-full rounded-xl text-white bg-[#342118] border-[#684231] h-14 p-[15px]" /></label>
                    <div class="flex flex-col items-center gap-2 p-4 rounded-xl border-2 border-dashed border-[#684231]"><p class="text-white text-lg font-bold">Upload Photo</p><input type="file" id="create-recipe-photoInput" accept="image/*" class="text-white text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[#492e22] file:text-white hover:file:bg-[#5a3a2a]"></div>
                </div>
                <div class="flex px-4 py-3 mt-4"><button id="save-recipe-button" class="flex w-full cursor-pointer items-center justify-center rounded-xl h-12 px-5 bg-[#f0560e] text-white text-base font-bold"><span class="truncate">Save Recipe</span></button></div>
            </div>
        </div>

        <div id="page-schedule" class="page bg-[#231610] dark group/design-root">
            <div class="page-header">
                <div class="flex items-center p-4 pb-2 justify-between">
                    <div class="text-white flex size-12 shrink-0 items-center cursor-pointer" data-action="back"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z"></path></svg></div>
                    <h2 class="text-white text-lg font-bold flex-1 text-center pr-12">Meal Planner</h2>
                </div>
            </div>
            <div class="page-content">
                <div class="flex items-center justify-between p-4 sticky top-0 bg-[#231610] z-10">
                    <button id="schedule-prev-week" class="text-white p-2 rounded-full hover:bg-white/10"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M165.66,202.34a8,8,0,0,1-11.32,11.32l-80-80a8,8,0,0,1,0-11.32l80-80a8,8,0,0,1,11.32,11.32L91.31,128Z"></path></svg></button>
                    <h3 id="schedule-week-range" class="text-white text-lg font-semibold text-center"></h3>
                    <button id="schedule-next-week" class="text-white p-2 rounded-full hover:bg-white/10"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z"></path></svg></button>
                </div>
                <div id="schedule-week-days" class="flex justify-around p-2 border-b border-gray-700 mb-3 sticky top-[72px] bg-[#231610] z-10"></div>
                <h2 id="schedule-selected-day-title" class="text-white text-[22px] font-bold px-4 pb-3 pt-2">Meals for Today</h2>
                <div id="schedule-meal-list" class="px-4"></div>
                <div class="flex justify-center px-4 py-5"><button id="schedule-open-add-meal-modal-button" class="flex items-center justify-center rounded-xl h-12 px-5 bg-[#f0560e] text-white text-base font-bold gap-2"><svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256"><path d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z"></path></svg><span>Add Meal</span></button></div>
            </div>
            <div id="add-meal-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[1100] hidden">
                <div class="bg-[#2e241f] p-4 rounded-lg shadow-xl w-11/12 max-w-md max-h-[80vh] flex flex-col">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-white text-xl font-bold">Add Recipe to Meal Plan</h3>
                        <button id="add-meal-modal-close-button" class="text-white p-1 hover:bg-white/10 rounded-full"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"></path></svg></button>
                    </div>
                    <div class="mb-3"><input type="text" id="add-meal-modal-search" placeholder="Search recipes..." class="form-input w-full rounded-lg text-white bg-[#40322b] border-[#684231] h-12 p-3 placeholder:text-[#bda89e] focus:ring-1 focus:ring-[#f0560e] focus:border-[#f0560e]"></div>
                    <div id="add-meal-modal-recipe-list" class="overflow-y-auto flex-grow space-y-2 pr-1"></div>
                </div>
            </div>
        </div>

        <!-- Page: Shopping List -->
        <div id="page-shopping-list" class="page bg-[#231610] dark group/design-root">
            <div class="page-header">
                <div class="flex items-center p-4 pb-2 justify-between">
                    <div class="text-white flex size-12 shrink-0 items-center cursor-pointer" data-action="back"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z"></path></svg></div>
                    <h2 class="text-white text-lg font-bold flex-1 text-center">Shopping List</h2>
                    <button id="clear-checked-shopping-items-button" title="Clear Checked Items" class="text-white flex size-12 items-center justify-center rounded-full hover:bg-white/10">
                         <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256"><path d="M228,56H205.12L148,26.12A20,20,0,0,0,112.35,32H72a20,20,0,0,0-20,20V208a20,20,0,0,0,40,0V96h24V208a20,20,0,0,0,40,0V96h24V208a20,20,0,0,0,40,0V88a20,20,0,0,0-13.17-18.72L232,64A12,12,0,0,0,228,56ZM72,72h40.35L148,89.88,112.35,104Zm24,120a4,4,0,0,1-8,0V96a4,4,0,0,1,8,0Zm40,0a4,4,0,0,1-8,0V96a4,4,0,0,1,8,0Zm40,0a4,4,0,0,1-8,0V88a4,4,0,0,1,8,0Z"></path></svg>
                    </button>
                </div>
            </div>
            <div class="page-content px-4 pt-4">
                <div id="shopping-list-items-container" class="space-y-2">
                    <!-- Shopping list items will be injected here -->
                </div>
            </div>
            <!-- Sticky Add Item Bar -->
            <div class="sticky bottom-[76px] left-0 right-0 bg-[#2e241f] p-3 border-t border-[#40322b] z-50 flex gap-2 items-center">
                 <input type="text" id="new-shopping-item-name" placeholder="Add item..." class="form-input flex-grow rounded-lg text-white bg-[#40322b] border-[#684231] h-11 p-3 placeholder:text-[#bda89e] focus:ring-1 focus:ring-[#f0560e] focus:border-[#f0560e]">
                 <button id="add-shopping-item-button" class="bg-[#f0560e] text-white rounded-lg p-2.5 h-11 w-11 flex items-center justify-center shrink-0 hover:bg-orange-600">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256"><path d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z"></path></svg>
                 </button>
            </div>
        </div>


        <div id="page-profile" class="page bg-[#1e1815] dark group/design-root">
            <div class="page-header">
                <div class="flex items-center p-4 pb-2 justify-center">
                    <h2 class="text-white text-lg font-bold">Profile</h2>
                </div>
            </div>
            <div class="page-content flex flex-col items-center justify-center">
                <h1 class="text-white text-3xl">Profile Page</h1>
                <p class="text-[#bda89e] mt-4">This is a placeholder. Click the Cookbook icon to go back.</p>
            </div>
        </div>
    </div>

    <div class="bottom-nav-bar">
        <div class="flex gap-1 px-2 pb-3 pt-2">
            <a class="nav-item just flex flex-1 flex-col items-center justify-end gap-1 rounded-full text-white" href="#" data-target="page-index" data-icon-name="BookOpen">
                <div class="nav-icon-container text-white flex h-8 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M224,48H160a40,40,0,0,0-32,16A40,40,0,0,0,96,48H32A16,16,0,0,0,16,64V192a16,16,0,0,0,16,16H96a24,24,0,0,1,24,24,8,8,0,0,0,16,0,24,24,0,0,1,24-24h64a16,16,0,0,0,16-16V64A16,16,0,0,0,224,48ZM96,192H32V64H96a24,24,0,0,1,24,24V200A39.81,39.81,0,0,0,96,192Zm128,0H160a39.81,39.81,0,0,0-24,8V88a24,24,0,0,1,24-24h64Z"></path></svg></div>
                <p class="nav-text text-white text-xs font-medium">Recipes</p>
            </a>
            <a class="nav-item just flex flex-1 flex-col items-center justify-end gap-1 text-[#bda89e]" href="#" data-target="page-favorites" data-icon-name="Heart"> 
                <div class="nav-icon-container text-[#bda89e] flex h-8 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M240,94c0,70-103.79,126.66-108.21,129a8,8,0,0,1-7.58,0C119.79,220.66,16,164,16,94A62.07,62.07,0,0,1,78,32c20.65,0,38.41,8.88,50,23.89C139.59,40.88,157.35,32,178,32A62.07,62.07,0,0,1,240,94Zm-16,0a46.06,46.06,0,0,0-46-46c-19.45,0-35.78,10.36-42.6,27a8,8,0,0,1-14.8,0C114.78,58.36,98.45,48,79,48a46.06,46.06,0,0,0-46,46c0,51.91,74.22,96.66,91.08,107.18a8,8,0,0,0,7.84,0C148.78,190.66,224,145.91,224,94Z"></path></svg></div>
                <p class="nav-text text-[#bda89e] text-xs font-medium">Favorites</p>
            </a>
            <a class="nav-item just flex flex-1 flex-col items-center justify-end gap-1 text-[#bda89e]" href="#" data-target="page-create-recipe" data-icon-name="PlusSquare">
                <div class="nav-icon-container text-[#bda89e] flex h-8 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M208,32H48A16,16,0,0,0,32,48V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V48A16,16,0,0,0,208,32Zm0,176H48V48H208V208Zm-32-80a8,8,0,0,1-8,8H136v32a8,8,0,0,1-16,0V136H88a8,8,0,0,1,0-16h32V88a8,8,0,0,1,16,0v32h32A8,8,0,0,1,176,128Z"></path></svg></div>
                <p class="nav-text text-[#bda89e] text-xs font-medium">Create</p>
            </a>
            <a class="nav-item just flex flex-1 flex-col items-center justify-end gap-1 text-[#bda89e]" href="#" data-target="page-shopping-list" data-icon-name="ShoppingCart"> <!-- New Shopping List Nav Item -->
                <div class="nav-icon-container text-[#bda89e] flex h-8 items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M96,216a16,16,0,1,1-16-16A16,16,0,0,1,96,216Zm88-16a16,16,0,1,0,16,16A16,16,0,0,0,184,200ZM228.1,65.21l-28.52,92.68A23.88,23.88,0,0,1,176.7,176H88.06A24,24,0,0,1,65.9,159.34L29.11,50.3A8,8,0,0,0,24,48H16a8,8,0,0,1,0-16H24a16,16,0,0,1,15.23,10.31L50.1,63.36A8,8,0,0,1,56,64H216a8,8,0,0,1,7.44,10.33A8.12,8.12,0,0,1,228.1,65.21ZM82.25,160H176.7a8,8,0,0,0,7.58-5.07L208,72H60.49Z"></path></svg>
                </div>
                <p class="nav-text text-[#bda89e] text-xs font-medium">Shopping</p>
            </a>
            <a class="nav-item just flex flex-1 flex-col items-center justify-end gap-1 text-[#bda89e]" href="#" data-target="page-schedule" data-icon-name="Calendar">
                <div class="nav-icon-container text-[#bda89e] flex h-8 items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M208,32H184V24a8,8,0,0,0-16,0v8H88V24a8,8,0,0,0-16,0v8H48A16,16,0,0,0,32,48V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V48A16,16,0,0,0,208,32ZM72,48v8a8,8,0,0,0,16,0V48h80v8a8,8,0,0,0,16,0V48h24V80H48V48ZM208,208H48V96H208V208Zm-96-88v64a8,8,0,0,1-16,0V132.94l-4.42,2.22a8,8,0,0,1-7.16-14.32l16-8A8,8,0,0,1,112,120Zm59.16,30.45L152,176h16a8,8,0,0,1,0,16H136a8,8,0,0,1-6.4-12.8l28.78-38.37A8,8,0,1,0,145.07,132a8,8,0,1,1-13.85-8A24,24,0,0,1,176,136,23.76,23.76,0,0,1,171.16,150.45Z"></path></svg></div>
                <p class="nav-text text-[#bda89e] text-xs font-medium">Meal Plan</p>
            </a>
        </div>
    </div>

    <script>
        // --- Global App Variables ---
        let currentPageId = 'page-index'; let previousPageId = 'page-index'; 
        let allRecipesCache = []; let editingRecipeId = null; let currentRecipeImageURL = null; 
        let currentSelectedDate = new Date(); let currentDisplayedWeekStartDate = getStartOfWeek(new Date()); 

        // --- Date Helper Functions ---
        function getStartOfWeek(d,s=0){const t=new Date(d),e=t.getDay(),a=(e<s?e+7:e)-s;return t.setDate(t.getDate()-a),t.setHours(0,0,0,0),t}
        function addDays(d,s){const t=new Date(d);return t.setDate(t.getDate()+s),t}
        function formatDateForDisplay(d){return isToday(d)?"Today":isSameDate(d,addDays(new Date,1))?"Tomorrow":d.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"})}
        function formatDateForFirebaseKey(d){return`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`}
        function isSameDate(d,s){return!(!d||!s)&&d.getFullYear()===s.getFullYear()&&d.getMonth()===s.getMonth()&&d.getDate()===s.getDate()}
        function isToday(d){return isSameDate(d,new Date)}

        // --- Debounce Utility ---
        function debounce(fn,dl){let t;return function(...a){clearTimeout(t),t=setTimeout(()=>fn.apply(this,a),dl)}}

        // --- Navigation and Page Display ---
        function showPage(pageId, fromBackButton = false) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                if (!fromBackButton && currentPageId !== pageId) previousPageId = currentPageId;
                targetPage.classList.add('active'); currentPageId = pageId;
                updateNavbarUI(pageId);
                const activePgContent = targetPage.querySelector('.page-content');
                if(activePgContent) activePgContent.scrollTop = 0;

                if (pageId === 'page-index') {
                    const searchInput = document.getElementById('search-recipe-input');
                    if (searchInput && searchInput.value.trim() === '') handleSearch(); 
                } else if (pageId === 'page-favorites') {
                    renderFavoritesPage();
                } else if (pageId === 'page-schedule') {
                    if (!fromBackButton || previousPageId !== 'page-recipe') { 
                        currentSelectedDate = new Date(); currentDisplayedWeekStartDate = getStartOfWeek(new Date()); 
                    }
                    renderWeekView(); 
                } else if (pageId === 'page-shopping-list') {
                    loadShoppingListFromDB();
                }
            } else { showPage('page-index'); }
        }

        function updateNavbarUI(activePageId) {
            document.querySelectorAll('.nav-item').forEach(item => {
                const target = item.dataset.target; let isEffActive = (target === activePageId);
                if (activePageId === 'page-recipe') {
                    if (target === previousPageId && (previousPageId==='page-index'||previousPageId==='page-favorites')) isEffActive = true;
                    else if (target==='page-index' && previousPageId!=='page-favorites') isEffActive = true;
                }
                const txtColor = isEffActive ? 'text-white' : 'text-[#bda89e]';
                const iconCont = item.querySelector('.nav-icon-container'), txtEl = item.querySelector('.nav-text');
                ['text-white','text-[#bda89e]'].forEach(c=>{item.classList.remove(c);if(txtEl)txtEl.classList.remove(c);if(iconCont)iconCont.classList.remove(c)});
                item.classList.add(txtColor); if(txtEl)txtEl.classList.add(txtColor); if(iconCont)iconCont.classList.add(txtColor);
                if (target==='page-favorites' && iconCont) {
                    const hrtSVG=iconCont.querySelector('svg'); if(hrtSVG) hrtSVG.innerHTML = isEffActive ? `<path d="M178,32c-20.65,0-38.41,8.88-50,23.89C116.41,40.88,98.65,32,78,32A62.07,62.07,0,0,0,16,94c0,70,103.79,126.66,108.21,129a8,8,0,0,0,7.58,0C136.21,220.66,240,164,240,94A62.07,62.07,0,0,0,178,32Z"></path>` : `<path d="M240,94c0,70-103.79,126.66-108.21,129a8,8,0,0,1-7.58,0C119.79,220.66,16,164,16,94A62.07,62.07,0,0,1,78,32c20.65,0,38.41,8.88,50,23.89C139.59,40.88,157.35,32,178,32A62.07,62.07,0,0,1,240,94Zm-16,0a46.06,46.06,0,0,0-46-46c-19.45,0-35.78,10.36-42.6,27a8,8,0,0,1-14.8,0C114.78,58.36,98.45,48,79,48a46.06,46.06,0,0,0-46,46c0,51.91,74.22,96.66,91.08,107.18a8,8,0,0,0,7.84,0C148.78,190.66,224,145.91,224,94Z"></path>`;
                }
            });
        }

        // --- Recipe CRUD ---
        async function loadRecipesFromRealtimeDB(){try{const s=await database.ref("recipes").orderByChild("createdAt").once("value");allRecipesCache=[],s.exists()&&(allRecipesCache=Object.keys(s.val()).map(t=>({id:t,...s.val()[t]})).sort((t,e)=>(e.createdAt||0)-(t.createdAt||0))),"page-index"===currentPageId?(document.getElementById("search-recipe-input")?.value.trim()?"":handleSearch()):"page-favorites"===currentPageId&&renderFavoritesPage()}catch(s){console.error("Error fetching recipes:",s),alert("Could not load recipes.")}}
        function populateRecipeListsUI(rcps,isSrchMd=!1){const f=document.getElementById("featured-recipes-container"),q=document.getElementById("quick-easy-recipes-container"),r=document.getElementById("recently-added-heading"),a=document.getElementById("all-recipes-heading");if(f.innerHTML="",q.innerHTML="",isSrchMd)r.style.display="none",a.style.display="none",f.style.display="none",0===rcps.length?q.innerHTML='<p class="text-center text-[#cba390] py-4 col-span-full w-full">No recipes found matching your search.</p>':rcps.forEach(t=>q.innerHTML+=createRecipeCardHtml(t));else{r.style.display="block",a.style.display="block",f.style.display="flex";const n='<p class="text-center text-[#cba390] py-4 px-4 w-full col-span-full">No recipes added yet. Create one!</p>';0===rcps.length?(f.innerHTML=n,q.innerHTML=n):rcps.forEach((t,e)=>{(e<5&&rcps.length>3||rcps.length<=3&&e<rcps.length)&&(f.innerHTML+=createRecipeCardHtml(t,!0)),q.innerHTML+=createRecipeCardHtml(t,!1)}),""===f.innerHTML&&rcps.length>0&&(r.style.display="none")}attachRecipeCardListeners()}
        function createRecipeCardHtml(r,f=!1){const d=(r.description||"No description.").substring(0,70)+( (r.description||"").length>70?"...":""),i=`style='background-image: url("${r.imageURL||"https://via.placeholder.com/300x200.png?text=No+Image"}");'`;return f?`<div class="flex h-full flex-1 flex-col gap-4 rounded-lg min-w-60 cursor-pointer" data-recipe-id="${r.id}"><div class="w-full bg-center bg-no-repeat aspect-video bg-cover rounded-xl" ${i}></div><div><p class="text-white text-base font-medium">${r.title||"Untitled"}</p><p class="text-[#bda89e] text-sm">${d}</p></div></div>`:`<div class="flex flex-col gap-3 pb-3 cursor-pointer" data-recipe-id="${r.id}"><div class="w-full bg-center bg-no-repeat aspect-square bg-cover rounded-xl" ${i}></div><div><p class="text-white text-base font-medium">${r.title||"Untitled"}</p><p class="text-[#bda89e] text-sm">${d}</p></div></div>`}
        function handleSearch(){const i=document.getElementById("search-recipe-input");if(!i)return;const t=i.value.trim().toLowerCase();""===t?populateRecipeListsUI(allRecipesCache,!1):populateRecipeListsUI(allRecipesCache.filter(e=>(e.title||"").toLowerCase().includes(t)||(e.description||"").toLowerCase().includes(t)),!0)}
        function renderFavoritesPage(){const i=document.getElementById("search-favorites-input"),t=i?i.value.trim().toLowerCase():"";let e=allRecipesCache.filter(c=>c.isBookmarked);""!==t&&(e=e.filter(c=>(c.title||"").toLowerCase().includes(t)||(c.description||"").toLowerCase().includes(t))),populateFavoritesListUI(e,""!==t)}
        function populateFavoritesListUI(fRcp,isSrchMd=!1){const c=document.getElementById("favorites-recipes-container");if(c.innerHTML="",0===fRcp.length){const t=isSrchMd?'<p class="text-center text-[#cba390] py-4 col-span-full w-full">No favorite recipes found matching your search.</p>':'<p class="text-center text-[#cba390] py-4 col-span-full w-full">No favorite recipes yet. Bookmark some!</p>';c.innerHTML=t}else fRcp.forEach(t=>c.innerHTML+=createRecipeCardHtml(t,!1));attachRecipeCardListeners()}
        function handleFavoritesSearch(){renderFavoritesPage()}
        function attachRecipeCardListeners(){document.querySelectorAll("[data-recipe-id]").forEach(c=>{c.removeEventListener("click",handleRecipeCardClick),c.addEventListener("click",handleRecipeCardClick)})}
        function handleRecipeCardClick(e){const i=e.currentTarget.dataset.recipeId;i&&loadRecipeDetailFromRealtimeDB(i)}
        async function loadRecipeDetailFromRealtimeDB(id){try{const s=await database.ref(`recipes/${id}`).once("value");s.exists()?(displayRecipeDetailsUI({id,...s.val()}),showPage("page-recipe")):(alert("Recipe not found."),showPage(previousPageId||"page-index",!0))}catch(s){console.error("Error getting recipe:",s)}}
        function displayRecipeDetailsUI(r){document.getElementById("page-recipe").dataset.currentRecipeId=r.id,document.getElementById("recipe-image").style.backgroundImage=`url("${r.imageURL||"https://via.placeholder.com/300x200.png?text=No+Image"}")`,document.getElementById("recipe-title").textContent=r.title||"Untitled",document.getElementById("recipe-description").textContent=r.description||"No description.";const i=document.getElementById("recipe-ingredients-list");i.innerHTML="",(r.ingredients||[]).forEach(t=>i.innerHTML+=`<label class="flex gap-x-3 py-3 items-center"><input type="checkbox" class="form-checkbox-custom"/><p class="text-white text-base">${t}</p></label>`);const n=document.getElementById("recipe-instructions-list");n.innerHTML="",(r.instructions||[]).forEach(t=>n.innerHTML+=`<div class="flex items-center min-h-14 py-1"><p class="text-white text-base flex-1">${t}</p></div>`);const b=document.getElementById("recipe-bookmark-icon");b.innerHTML=r.isBookmarked?'<path d="M184,32H72A16,16,0,0,0,56,48V224a8,8,0,0,0,12.24,6.78L128,193.43l59.77,37.35A8,8,0,0,0,200,224V48A16,16,0,0,0,184,32Z"></path>':'<path d="M184,32H72A16,16,0,0,0,56,48V224a8,8,0,0,0,12.24,6.78L128,193.43l59.77,37.35A8,8,0,0,0,200,224V48A16,16,0,0,0,184,32Zm0,177.57-51.77-32.35a8,8,0,0,0-8.48,0L72,209.57V48H184Z"></path>',b.classList.toggle("text-[#f0560e]",!!r.isBookmarked),b.classList.toggle("text-white",!r.isBookmarked),document.getElementById("recipe-bookmark-button").dataset.recipeId=r.id,document.getElementById("delete-recipe-button").dataset.recipeId=r.id,document.getElementById("delete-recipe-button").dataset.imageURL=r.imageURL||""}
        function resetCreateForm(){document.getElementById("create-recipe-title").value="",document.getElementById("create-recipe-description").value="",document.getElementById("create-recipe-ingredients").value="",document.getElementById("create-recipe-instructions").value="",document.getElementById("create-recipe-prepTime").value="",document.getElementById("create-recipe-cookTime").value="",document.getElementById("create-recipe-servings").value="",document.getElementById("create-recipe-photoInput").value="",document.querySelector("#page-create-recipe .page-header h2").textContent="New Recipe",editingRecipeId=null,currentRecipeImageURL=null}
        async function prepareEditForm(id){const r=database.ref(`recipes/${id}`);try{const s=await r.once("value");if(s.exists()){const t=s.val();editingRecipeId=id,currentRecipeImageURL=t.imageURL||"",document.querySelector("#page-create-recipe .page-header h2").textContent="Edit Recipe",document.getElementById("create-recipe-title").value=t.title||"",document.getElementById("create-recipe-description").value=t.description||"",document.getElementById("create-recipe-ingredients").value=(t.ingredients||[]).join("\n"),document.getElementById("create-recipe-instructions").value=(t.instructions||[]).join("\n"),document.getElementById("create-recipe-prepTime").value=t.prepTime||"",document.getElementById("create-recipe-cookTime").value=t.cookTime||"",document.getElementById("create-recipe-servings").value=t.servings||"",document.getElementById("create-recipe-photoInput").value="",showPage("page-create-recipe")}else alert("Recipe not found for editing."),resetCreateForm()}catch(s){console.error("Error fetching for edit:",s),alert("Could not load for editing."),resetCreateForm()}}
        async function saveRecipeData(){const t=document.getElementById("create-recipe-title").value.trim();if(!t)return void alert("Recipe title is required.");const d=document.getElementById("create-recipe-description").value.trim(),i=document.getElementById("create-recipe-ingredients").value.split("\n").map(s=>s.trim()).filter(s=>s),n=document.getElementById("create-recipe-instructions").value.split("\n").map(s=>s.trim()).filter(s=>s),p=document.getElementById("create-recipe-prepTime").value.trim(),c=document.getElementById("create-recipe-cookTime").value.trim(),v=document.getElementById("create-recipe-servings").value.trim(),u=document.getElementById("create-recipe-photoInput"),l=document.getElementById("save-recipe-button");l.textContent="Saving...",l.disabled=!0;let g=editingRecipeId?currentRecipeImageURL:"";try{if(u.files[0]){const s=u.files[0],e=new FormData;e.append("file",s),e.append("upload_preset",CLOUDINARY_UPLOAD_PRESET);const a=await fetch(CLOUDINARY_UPLOAD_URL,{method:"POST",body:e}),o=await a.json();if(o.secure_url)g=o.secure_url;else throw new Error(o.error?.message||"Cloudinary upload failed")}const m={title:t,description:d,ingredients:i,instructions:n,prepTime:p,cookTime:c,servings:v,imageURL:g,isBookmarked:editingRecipeId?allRecipesCache.find(s=>s.id===editingRecipeId)?.isBookmarked||!1:!1};if(editingRecipeId){const s=await database.ref(`recipes/${editingRecipeId}/createdAt`).once("value");m.createdAt=s.exists()?s.val():serverTimestamp,m.updatedAt=serverTimestamp,await database.ref(`recipes/${editingRecipeId}`).update(m),alert("Recipe updated!")}else m.createdAt=serverTimestamp,await database.ref("recipes").push().set(m),alert("Recipe saved!");resetCreateForm(),await loadRecipesFromRealtimeDB(),showPage("page-index")}catch(s){console.error("Error saving recipe:",s),alert(`Failed to save: ${s.message}`)}finally{l.textContent="Save Recipe",l.disabled=!1}}
        async function deleteRecipeFromRealtimeDB(id,img){if(!confirm("Delete this recipe?"))return;try{await database.ref(`recipes/${id}`).remove(),alert("Recipe deleted."),await loadRecipesFromRealtimeDB(),showPage(previousPageId||"page-index",!0)}catch(s){console.error("Error deleting recipe:",s),alert("Failed to delete.")}}
        async function toggleBookmarkInRealtimeDB(id){const r=database.ref(`recipes/${id}`);try{const s=await r.once("value");if(s.exists()){const t=!s.val().isBookmarked;await r.update({isBookmarked:t});const n=document.getElementById("recipe-bookmark-icon");n.innerHTML=t?'<path d="M184,32H72A16,16,0,0,0,56,48V224a8,8,0,0,0,12.24,6.78L128,193.43l59.77,37.35A8,8,0,0,0,200,224V48A16,16,0,0,0,184,32Z"></path>':'<path d="M184,32H72A16,16,0,0,0,56,48V224a8,8,0,0,0,12.24,6.78L128,193.43l59.77,37.35A8,8,0,0,0,200,224V48A16,16,0,0,0,184,32Zm0,177.57-51.77-32.35a8,8,0,0,0-8.48,0L72,209.57V48H184Z"></path>',n.classList.toggle("text-[#f0560e]",t),n.classList.toggle("text-white",!t);const a=allRecipesCache.find(e=>e.id===id);a&&(a.isBookmarked=t),"page-favorites"===currentPageId&&!t&&renderFavoritesPage()}}catch(s){console.error("Error toggling bookmark:",s)}}

        // --- Meal Planning ---
        function renderWeekView(){const w=document.getElementById("schedule-week-days"),r=document.getElementById("schedule-week-range");if(!w||!r)return;w.innerHTML="";const dS=new Intl.DateTimeFormat("en-US",{weekday:"short"}),dN=new Intl.DateTimeFormat("en-US",{day:"numeric"});let t=new Date(currentDisplayedWeekStartDate);for(let i=0;i<7;i++){const e=document.createElement("button");e.className="schedule-day-btn flex flex-col items-center p-1.5 fo w-[calc(100%/7-4px)] mx-0.5",e.dataset.date=t.toISOString();const a=isToday(t),o=isSameDate(t,currentSelectedDate);e.innerHTML=`<span class="day-name-span text-xs ${a&&!o?"text-[#f0560e]":"text-gray-400"}">${dS.format(t).toUpperCase()}</span><span class="day-number-span text-lg font-bold ${a&&!o?"text-[#f0560e]":"text-white"}">${dN.format(t)}</span>`,o&&e.classList.add("selected"),a&&e.classList.add("today"),e.addEventListener("click",handleWeekDayClick),w.appendChild(e),t=addDays(t,1)}r.textContent=`${currentDisplayedWeekStartDate.toLocaleDateString("en-US",{month:"short",day:"numeric"})} - ${addDays(currentDisplayedWeekStartDate,6).toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})}`,loadMealsForSelectedDate()}
        function handleWeekDayClick(e){currentSelectedDate=new Date(e.currentTarget.dataset.date),renderWeekView()}
        function navigateToPreviousWeek(){currentDisplayedWeekStartDate=addDays(currentDisplayedWeekStartDate,-7),currentSelectedDate=new Date(currentDisplayedWeekStartDate),renderWeekView()}
        function navigateToNextWeek(){currentDisplayedWeekStartDate=addDays(currentDisplayedWeekStartDate,7),currentSelectedDate=new Date(currentDisplayedWeekStartDate),renderWeekView()}
        function loadMealsForSelectedDate(){const t=document.getElementById("schedule-selected-day-title");t&&(t.textContent=`Meals for ${formatDateForDisplay(currentSelectedDate)}`,loadMealPlanForDateFromRealtimeDB(formatDateForFirebaseKey(currentSelectedDate)))}
        async function loadMealPlanForDateFromRealtimeDB(dStr){const m=document.getElementById("schedule-meal-list");if(!m)return;m.innerHTML='<p class="text-center text-[#cba390] py-4">Loading meals...</p>';try{const s=await database.ref(`mealPlan/${dStr}`).once("value");displayPlannedMealsUI(s.exists()?s.val():{},dStr)}catch(s){console.error("Error fetching meal plan:",s),m.innerHTML='<p class="text-center text-red-500 py-4">Error loading meals.</p>'}}
        function displayPlannedMealsUI(mData,dStr){const mLst=document.getElementById("schedule-meal-list");if(!mLst)return;mLst.innerHTML="",0===Object.keys(mData).length?(mLst.innerHTML='<p class="text-center text-[#cba390] py-4">No meals planned.</p>',void 0):Object.entries(mData).forEach(([mId,m])=>{const rD=allRecipesCache.find(t=>t.id===m.recipeId),img=rD?.imageURL||"https://via.placeholder.com/100x100.png?text=No+Img",cT=rD?.cookTime||"N/A",mDiv=document.createElement("div");mDiv.className="flex items-center justify-between gap-4 p-2 mb-2 bg-[#40322b] rounded-lg",mDiv.dataset.recipeId=m.recipeId,mDiv.dataset.mealPlanEntryId=mId,mDiv.innerHTML=`<div class="flex items-center gap-3 flex-grow cursor-pointer" data-action="view-recipe-from-plan"><div class="bg-center bg-no-repeat aspect-square bg-cover rounded-md size-14 shrink-0" style='background-image: url("${img}");'></div><div><p class="text-white text-base font-medium">${m.recipeTitle||"Unknown"}</p><p class="text-[#cba390] text-sm">Cook: ${cT}</p></div></div><button class="remove-meal-button text-red-400 hover:text-red-600 p-2 rounded-full hover:bg-white/10" title="Remove"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M216,48H176V40a24,24,0,0,0-24-24H104A24,24,0,0,0,80,40v8H40a8,8,0,0,0,0,16h8V208a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V64h8a8,8,0,0,0,0-16ZM96,40a8,8,0,0,1,8-8h48a8,8,0,0,1,8,8v8H96Zm96,168H64V64H192ZM112,104v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm48,0v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Z"></path></svg></button>`,mLst.appendChild(mDiv),mDiv.querySelector(".remove-meal-button").addEventListener("click",t=>{t.stopPropagation(),handleRemoveMealClick(dStr,mId)}),mDiv.querySelector('[data-action="view-recipe-from-plan"]').addEventListener("click",()=>{mDiv.dataset.recipeId&&loadRecipeDetailFromRealtimeDB(mDiv.dataset.recipeId)})})}
        async function handleRemoveMealClick(dStr,mId){if(!confirm("Remove meal?"))return;try{await database.ref(`mealPlan/${dStr}/${mId}`).remove(),loadMealsForSelectedDate()}catch(s){console.error("Error removing meal:",s),alert("Failed to remove.")}}
        const addMealModal=document.getElementById("add-meal-modal"),addMealModalRecipeList=document.getElementById("add-meal-modal-recipe-list"),addMealModalSearchInput=document.getElementById("add-meal-modal-search");
        function openAddMealModal(){addMealModal&&addMealModalSearchInput&&(populateAddMealModalRecipeList(allRecipesCache),addMealModalSearchInput.value="",addMealModal.classList.remove("hidden"))}
        function closeAddMealModal(){addMealModal&&addMealModal.classList.add("hidden")}
        function populateAddMealModalRecipeList(rcps){if(!addMealModalRecipeList)return;addMealModalRecipeList.innerHTML="",0===rcps.length?(addMealModalRecipeList.innerHTML='<p class="text-center text-[#bda89e] py-3">No recipes.</p>',void 0):rcps.forEach(r=>{const i=document.createElement("div");i.className="add-meal-recipe-item flex items-center p-2 bg-[#40322b] rounded-lg cursor-pointer hover:bg-[#5a3a2a]",i.dataset.recipeId=r.id,i.dataset.recipeTitle=r.title;const n=r.imageURL||"https://via.placeholder.com/50x50.png?text=No+Img";i.innerHTML=`<img src="${n}" alt="${r.title}" class="w-12 h-12 rounded-md mr-3 object-cover shrink-0"><span class="text-white flex-grow truncate" title="${r.title}">${r.title||"Untitled"}</span><button class="add-this-recipe-button bg-[#f0560e] text-white text-xs px-3 py-1.5 rounded-md ml-2 shrink-0 hover:bg-orange-600">Add</button>`;const a=i.querySelector(".add-this-recipe-button");a&&a.addEventListener("click",t=>{t.stopPropagation(),handleAddRecipeToPlan(r.id,r.title)}),i.addEventListener("click",()=>handleAddRecipeToPlan(r.id,r.title)),addMealModalRecipeList.appendChild(i)})}
        function handleAddMealModalSearch(){if(!addMealModalSearchInput)return;const t=addMealModalSearchInput.value.trim().toLowerCase();""===t?populateAddMealModalRecipeList(allRecipesCache):populateAddMealModalRecipeList(allRecipesCache.filter(e=>(e.title||"").toLowerCase().includes(t)||(e.description||"").toLowerCase().includes(t)))}
        async function handleAddRecipeToPlan(id,title){const d=formatDateForFirebaseKey(currentSelectedDate);try{await database.ref(`mealPlan/${d}`).push({recipeId:id,recipeTitle:title}),closeAddMealModal(),loadMealsForSelectedDate()}catch(s){console.error("Error adding to meal plan:",s),alert("Failed to add.")}}
        
        // --- Shopping List Logic ---
        const shoppingListItemsContainer = document.getElementById('shopping-list-items-container');
        const newShoppingItemNameInput = document.getElementById('new-shopping-item-name');

        async function loadShoppingListFromDB() {
            if (!shoppingListItemsContainer) return;
            shoppingListItemsContainer.innerHTML = '<p class="text-center text-[#cba390] py-4">Loading shopping list...</p>';
            try {
                const snapshot = await database.ref('shoppingList').orderByChild('createdAt').once('value');
                const items = [];
                if (snapshot.exists()) {
                    snapshot.forEach(childSnapshot => {
                        items.push({ id: childSnapshot.key, ...childSnapshot.val() });
                    });
                }
                displayShoppingListUI(items.reverse()); // Show newest first, or sort by checked status then name
            } catch (error) {
                console.error("Error loading shopping list:", error);
                shoppingListItemsContainer.innerHTML = '<p class="text-center text-red-500 py-4">Error loading shopping list.</p>';
            }
        }

        function displayShoppingListUI(items) {
            if (!shoppingListItemsContainer) return;
            shoppingListItemsContainer.innerHTML = '';
            if (items.length === 0) {
                shoppingListItemsContainer.innerHTML = '<p class="text-center text-[#cba390] py-6">Your shopping list is empty!</p>';
                return;
            }
            // Sort items: unchecked first, then by name
            items.sort((a, b) => {
                if (a.checked === b.checked) return (a.name || "").localeCompare(b.name || "");
                return a.checked ? 1 : -1;
            });

            items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = `shopping-item flex items-center gap-3 p-3 bg-[#40322b] rounded-lg ${item.checked ? 'checked' : ''}`;
                itemDiv.dataset.itemId = item.id;

                itemDiv.innerHTML = `
                    <input type="checkbox" class="form-checkbox-custom" ${item.checked ? 'checked' : ''}>
                    <span class="item-name text-white flex-grow">${item.name || 'Unnamed Item'}</span>
                    <button class="delete-shopping-item-button text-gray-500 hover:text-red-500 p-1 rounded-full hover:bg-white/10">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 256 256"><path d="M216,48H176V40a24,24,0,0,0-24-24H104A24,24,0,0,0,80,40v8H40a8,8,0,0,0,0,16h8V208a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V64h8a8,8,0,0,0,0-16ZM96,40a8,8,0,0,1,8-8h48a8,8,0,0,1,8,8v8H96Zm96,168H64V64H192ZM112,104v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm48,0v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Z"></path></svg>
                    </button>
                `;
                shoppingListItemsContainer.appendChild(itemDiv);

                itemDiv.querySelector('.form-checkbox-custom').addEventListener('change', (e) => {
                    toggleShoppingItemCheckedInDB(item.id, !e.target.checked); // Pass the new desired state
                });
                itemDiv.querySelector('.delete-shopping-item-button').addEventListener('click', () => {
                    deleteShoppingItemFromDB(item.id);
                });
            });
        }

        async function addShoppingItemToDB() {
            if (!newShoppingItemNameInput) return;
            const itemName = newShoppingItemNameInput.value.trim();
            if (!itemName) {
                alert("Please enter an item name.");
                return;
            }
            try {
                await database.ref('shoppingList').push({
                    name: itemName,
                    checked: false,
                    createdAt: serverTimestamp
                });
                newShoppingItemNameInput.value = '';
                newShoppingItemNameInput.focus();
                loadShoppingListFromDB();
            } catch (error) {
                console.error("Error adding shopping item:", error);
                alert("Failed to add item to shopping list.");
            }
        }
        async function toggleShoppingItemCheckedInDB(itemId, isChecked) {
            try {
                await database.ref(`shoppingList/${itemId}`).update({ checked: isChecked });
                loadShoppingListFromDB(); // Reload to re-sort and re-style
            } catch (error) {
                console.error("Error updating shopping item checked status:", error);
            }
        }
        async function deleteShoppingItemFromDB(itemId) {
            // No confirmation for individual delete for speed, can be added if desired
            try {
                await database.ref(`shoppingList/${itemId}`).remove();
                loadShoppingListFromDB();
            } catch (error) {
                console.error("Error deleting shopping item:", error);
            }
        }
        async function clearCheckedShoppingItemsFromDB() {
            if (!confirm("Are you sure you want to clear all checked items?")) return;
            try {
                const snapshot = await database.ref('shoppingList').orderByChild('checked').equalTo(true).once('value');
                if (snapshot.exists()) {
                    const updates = {};
                    snapshot.forEach(child => {
                        updates[child.key] = null;
                    });
                    await database.ref('shoppingList').update(updates);
                }
                loadShoppingListFromDB();
            } catch (error) {
                console.error("Error clearing checked items:", error);
                alert("Failed to clear checked items.");
            }
        }


        // --- Event Listeners Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            showPage('page-index'); loadRecipesFromRealtimeDB(); 

            document.getElementById('search-recipe-input')?.addEventListener('input', debounce(handleSearch, 300));
            document.getElementById('search-favorites-input')?.addEventListener('input', debounce(handleFavoritesSearch, 300));
            
            document.querySelectorAll('.nav-item').forEach(item => item.addEventListener('click', (e) => {
                e.preventDefault(); const targetPageId = item.dataset.target;
                if (targetPageId === 'page-create-recipe') resetCreateForm(); 
                showPage(targetPageId);
            }));

            document.querySelectorAll('[data-action="back"]').forEach(btn => btn.addEventListener('click', () => {
                let targetBackPage = previousPageId || 'page-index';
                if (currentPageId === 'page-favorites' || currentPageId === 'page-schedule' || currentPageId === 'page-shopping-list') {
                    targetBackPage = 'page-index'; 
                }
                showPage(targetBackPage, true);
            }));
            document.querySelector('[data-action="back-from-create"]')?.addEventListener('click', () => {
                resetCreateForm(); showPage(previousPageId || 'page-index', true);
            });

            // Header Profile Buttons
            document.getElementById('header-profile-button-index')?.addEventListener('click', () => showPage('page-profile'));
            document.getElementById('header-profile-button-favorites')?.addEventListener('click', () => showPage('page-profile'));


            document.getElementById('save-recipe-button')?.addEventListener('click', saveRecipeData);
            document.getElementById('recipe-bookmark-button')?.addEventListener('click', (e) => { if (e.currentTarget.dataset.recipeId) toggleBookmarkInRealtimeDB(e.currentTarget.dataset.recipeId); });
            document.getElementById('delete-recipe-button')?.addEventListener('click', (e) => { if (e.currentTarget.dataset.recipeId) deleteRecipeFromRealtimeDB(e.currentTarget.dataset.recipeId, e.currentTarget.dataset.imageURL); });
            document.getElementById('recipe-edit-button')?.addEventListener('click', () => {
                const recipeId = document.getElementById('page-recipe').dataset.currentRecipeId;
                if (recipeId) prepareEditForm(recipeId); else { alert("Could not initiate edit."); }
            });

            document.getElementById('schedule-prev-week')?.addEventListener('click', navigateToPreviousWeek);
            document.getElementById('schedule-next-week')?.addEventListener('click', navigateToNextWeek);
            document.getElementById('schedule-open-add-meal-modal-button')?.addEventListener('click', openAddMealModal);
            document.getElementById('add-meal-modal-close-button')?.addEventListener('click', closeAddMealModal);
            if(addMealModalSearchInput) addMealModalSearchInput.addEventListener('input', debounce(handleAddMealModalSearch, 300));
        
            // Shopping List Listeners
            document.getElementById('add-shopping-item-button')?.addEventListener('click', addShoppingItemToDB);
            if (newShoppingItemNameInput) {
                newShoppingItemNameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault(); // Prevent form submission if it were in a form
                        addShoppingItemToDB();
                    }
                });
            }
            document.getElementById('clear-checked-shopping-items-button')?.addEventListener('click', clearCheckedShoppingItemsFromDB);
        });
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => { navigator.serviceWorker.register('/cookbook_bare/sw.js', { scope: '/cookbook_bare/' }).then(reg => console.log('SW registered!', reg.scope)).catch(err => console.log('SW registration failed: ', err)); });
        }
    </script>
</body>

</html>