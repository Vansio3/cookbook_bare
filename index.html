<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1e1815">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">

    <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin="" />
    <link rel="stylesheet" as="style" onload="this.rel='stylesheet'"
        href="https://fonts.googleapis.com/css2?display=swap&family=Noto+Sans%3Awght%40400%3B500%3B700%3B900&family=Plus+Jakarta+Sans%3Awght%40400%3B500%3B700%3B800" />
    <title>Cookbook App</title>
    <link rel="icon" type="image/x-icon" href="data:image/x-icon;base64," />
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style>
        body {
            font-family: "Plus Jakarta Sans", "Noto Sans", sans-serif;
            --checkbox-tick-svg: url('data:image/svg+xml,%3csvg viewBox=%270 0 16 16%27 fill=%27rgb(255,255,255)%27 xmlns=%27http://www.w3.org/2000/svg%27%3e%3cpath d=%27M12.207 4.793a1 1 0 010 1.414l-5 5a1 1 0 01-1.414 0l-2-2a1 1 0 011.414-1.414L6.5 9.086l4.293-4.293a1 1 0 011.414 0z%27/%3e%3c/svg%3e');
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            background-color: #1e1815;
        }

        .page-container {
            flex-grow: 1;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        .page {
            display: none;
            flex-direction: column;
            width: 100%;
            flex-grow: 1;
        }

        .page.active {
            display: flex;
        }

        .page-header {
            position: sticky;
            top: 0;
            z-index: 900;
        }

        #page-index .page-header { 
            background-color: #1e1815;
        }
        /* Updated to include #page-favorites header style */
        #page-favorites .page-header {
            background-color: #1e1815; 
        }


        #page-recipe .page-header,
        #page-create-recipe .page-header,
        #page-schedule .page-header {
            background-color: #231610;
        }

        #page-profile .page-header {
            background-color: #1e1815;
        }

        .page-content {
            flex-grow: 1;
            overflow-y: auto;
            padding-bottom: 90px;
        }

        .bottom-nav-bar {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            border-top: 1px solid #40322b;
            background-color: #2e241f;
        }

        .form-checkbox-custom {
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            height: 1.25rem;
            width: 1.25rem;
            border-radius: 0.25rem;
            border-width: 2px;
            border-color: #684231;
            background-color: transparent;
            flex-shrink: 0;
        }

        .form-checkbox-custom:checked {
            background-color: #f0560e;
            border-color: #f0560e;
            background-image: var(--checkbox-tick-svg);
            background-repeat: no-repeat;
            background-position: center;
            background-size: 70%;
        }

        .form-checkbox-custom:focus {
            outline: none;
            box-shadow: none;
            border-color: #684231;
        }

        .horizontal-scroll-cards {
            overflow-x: auto;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .horizontal-scroll-cards::-webkit-scrollbar {
            display: none;
        }
        
        .schedule-day-btn.selected {
            background-color: #40322b; 
            border-radius: 0.5rem; 
        }
        .schedule-day-btn.today:not(.selected) .day-number-span { 
            box-shadow: 0 0 0 2px #f0560e;
            border-radius: 9999px; 
            padding-left: 0.25rem; padding-right: 0.25rem; 
            padding-top: 0.125rem; padding-bottom: 0.125rem; 
        }
        .schedule-day-btn.today.selected { 
             border: 2px solid #f0560e;
        }
        .schedule-day-btn.today .day-name-span,
        .schedule-day-btn.today .day-number-span {
            color: #f0560e; 
        }
        .schedule-day-btn.selected:not(.today) .day-name-span {
            color: #d1d5db; 
        }
         .schedule-day-btn.selected:not(.today) .day-number-span {
            color: #ffffff; 
        }
    </style>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <!-- No firebase-storage.js needed for Cloudinary -->

    <script>
        const firebaseConfig = {
            apiKey: "%%FIREBASE_API_KEY%%",
            authDomain: "%%FIREBASE_AUTH_DOMAIN%%",
            projectId: "%%FIREBASE_PROJECT_ID%%",
            databaseURL: "%%FIREBASE_DATABASE_URL%%",
            storageBucket: "%%FIREBASE_STORAGE_BUCKET%%",
            messagingSenderId: "%%FIREBASE_MESSAGING_SENDER_ID%%",
            appId: "%%FIREBASE_APP_ID%%",
            measurementId: "%%FIREBASE_MEASUREMENT_ID%%"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database(); // Use Realtime Database
        const serverTimestamp = firebase.database.ServerValue.TIMESTAMP;

        const CLOUDINARY_CLOUD_NAME = "%%CLOUDINARY_CLOUD_NAME%%";
        const CLOUDINARY_UPLOAD_PRESET = "%%CLOUDINARY_UPLOAD_PRESET%%";
        const CLOUDINARY_UPLOAD_URL = `https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`;
    </script>
</head>

<body>

    <div class="page-container">
        <!-- Page: Index (Recipes List) -->
        <div id="page-index" class="page bg-[#1e1815] dark group/design-root">
            <div class="page-header">
                <div class="flex items-center p-4 pb-2 justify-between">
                    <h2 class="text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center">
                        Opi's Cookbook</h2>
                </div>
                <div class="px-4 py-3">
                    <label class="flex flex-col min-w-40 h-12 w-full">
                        <div class="flex w-full flex-1 items-stretch rounded-xl h-full">
                            <div
                                class="text-[#bda89e] flex border-none bg-[#40322b] items-center justify-center pl-4 rounded-l-xl border-r-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
                                    viewBox="0 0 256 256">
                                    <path
                                        d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z">
                                    </path>
                                </svg>
                            </div>
                            <input placeholder="Search recipes" id="search-recipe-input"
                                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border-none bg-[#40322b] focus:border-none h-full placeholder:text-[#bda89e] px-4 rounded-l-none border-l-0 pl-2" />
                        </div>
                    </label>
                </div>
            </div>
            <div class="page-content">
                <h2 id="recently-added-heading" class="text-white text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">Recently Added</h2>
                <div class="horizontal-scroll-cards flex">
                    <div id="featured-recipes-container" class="flex items-stretch p-4 gap-3"></div>
                </div>
                <h2 id="all-recipes-heading" class="text-white text-[22px] font-bold leading-tight tracking-[-0.015em] px-4 pb-3 pt-5">All Recipes</h2>
                <div id="quick-easy-recipes-container"
                    class="grid grid-cols-[repeat(auto-fit,minmax(158px,1fr))] gap-3 p-4"></div>
            </div>
        </div>

        <!-- Page: Favorites (Bookmarked Recipes List) -->
        <div id="page-favorites" class="page bg-[#1e1815] dark group/design-root">
            <div class="page-header">
                <div class="flex items-center p-4 pb-2 justify-between">
                     <div class="text-white flex size-12 shrink-0 items-center cursor-pointer" data-action="back"><svg
                            xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
                            viewBox="0 0 256 256">
                            <path
                                d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z">
                            </path>
                        </svg></div>
                    <h2 class="text-white text-lg font-bold leading-tight tracking-[-0.015em] flex-1 text-center pr-12">
                        Favorite Recipes
                    </h2>
                </div>
                <div class="px-4 py-3">
                    <label class="flex flex-col min-w-40 h-12 w-full">
                        <div class="flex w-full flex-1 items-stretch rounded-xl h-full">
                            <div
                                class="text-[#bda89e] flex border-none bg-[#40322b] items-center justify-center pl-4 rounded-l-xl border-r-0">
                                <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
                                    viewBox="0 0 256 256">
                                    <path
                                        d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z">
                                    </path>
                                </svg>
                            </div>
                            <input placeholder="Search favorite recipes" id="search-favorites-input"
                                class="form-input flex w-full min-w-0 flex-1 resize-none overflow-hidden rounded-xl text-white focus:outline-0 focus:ring-0 border-none bg-[#40322b] focus:border-none h-full placeholder:text-[#bda89e] px-4 rounded-l-none border-l-0 pl-2" />
                        </div>
                    </label>
                </div>
            </div>
            <div class="page-content">
                <div id="favorites-recipes-container"
                    class="grid grid-cols-[repeat(auto-fit,minmax(158px,1fr))] gap-3 p-4">
                </div>
            </div>
        </div>

        <div id="page-recipe" class="page bg-[#231610] dark group/design-root">
            <div class="page-header">
                <div class="flex items-center p-4 pb-2 justify-between">
                    <div class="text-white flex size-12 shrink-0 items-center cursor-pointer" data-action="back"><svg
                            xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
                            viewBox="0 0 256 256">
                            <path
                                d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z">
                            </path>
                        </svg></div>
                    <div class="flex items-center justify-end gap-1">
                        <button id="recipe-edit-button" title="Edit Recipe"
                            class="flex h-12 w-12 items-center justify-center rounded-lg text-white hover:bg-white/10">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M227.31,73.37,182.63,28.68a16,16,0,0,0-22.63,0L36.69,152A15.86,15.86,0,0,0,32,163.31V208a16,16,0,0,0,16,16H92.69A15.86,15.86,0,0,0,104,219.31L227.31,96a16,16,0,0,0,0-22.63ZM92.69,208H48V163.31l88-88L180.69,120ZM192,108.68,147.31,64l24-24L216,84.68Z"></path></svg>
                        </button>
                        <button id="recipe-bookmark-button"
                            class="flex h-12 w-12 items-center justify-center rounded-lg text-white hover:bg-white/10"> 
                            <div class="text-white"><svg id="recipe-bookmark-icon" xmlns="http://www.w3.org/2000/svg"
                                    width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                                    <path d="M184,32H72A16,16,0,0,0,56,48V224a8,8,0,0,0,12.24,6.78L128,193.43l59.77,37.35A8,8,0,0,0,200,224V48A16,16,0,0,0,184,32Zm0,177.57-51.77-32.35a8,8,0,0,0-8.48,0L72,209.57V48H184Z"></path>
                                </svg></div>
                        </button>
                    </div>
                </div>
            </div>
            <div class="page-content">
                <div class="@container">
                    <div class="@[480px]:px-4 @[480px]:py-3">
                        <div id="recipe-image"
                            class="w-full bg-center bg-no-repeat bg-cover flex flex-col justify-end overflow-hidden @[480px]:rounded-xl min-h-80">
                        </div>
                    </div>
                </div>
                <h1 id="recipe-title" class="text-white text-[22px] font-bold px-4 pb-3 pt-5"></h1>
                <p id="recipe-description" class="text-white text-base px-4 pb-3 pt-1"></p>
                <h3 class="text-white text-lg font-bold px-4 pb-2 pt-4">Ingredients</h3>
                <div id="recipe-ingredients-list" class="px-4"></div>
                <h3 class="text-white text-lg font-bold px-4 pb-2 pt-4">Instructions</h3>
                <div id="recipe-instructions-list" class="px-4"></div>
                <div class="px-4 py-6"><button id="delete-recipe-button"
                        class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-xl">Delete
                        Recipe</button></div>
            </div>
        </div>

        <div id="page-create-recipe" class="page bg-[#231610] dark group/design-root">
            <div class="page-header">
                <div class="flex items-center p-4 pb-2 justify-between">
                    <div class="text-white flex size-12 shrink-0 items-center cursor-pointer" data-action="back-from-create"><svg
                            xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
                            viewBox="0 0 256 256">
                            <path
                                d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z">
                            </path>
                        </svg></div>
                    <h2 class="text-white text-lg font-bold flex-1 text-center pr-12">New Recipe</h2> 
                </div>
            </div>
            <div class="page-content">
                <div class="flex max-w-[480px] flex-col gap-4 px-4 py-3 mx-auto w-full">
                    <label class="flex flex-col w-full">
                        <p class="text-white text-base font-medium pb-2">Recipe Title</p><input id="create-recipe-title"
                            placeholder="Enter recipe title"
                            class="form-input w-full rounded-xl text-white bg-[#342118] border-[#684231] h-14 p-[15px]" />
                    </label>
                    <label class="flex flex-col w-full">
                        <p class="text-white text-base font-medium pb-2">Description</p><textarea
                            id="create-recipe-description" placeholder="Brief description"
                            class="form-input w-full rounded-xl text-white bg-[#342118] border-[#684231] min-h-24 p-[15px]"></textarea>
                    </label>
                    <label class="flex flex-col w-full">
                        <p class="text-white text-base font-medium pb-2">Ingredients (one per line)</p><textarea
                            id="create-recipe-ingredients" placeholder="Flour, 1 cup..."
                            class="form-input w-full rounded-xl text-white bg-[#342118] border-[#684231] min-h-36 p-[15px]"></textarea>
                    </label>
                    <label class="flex flex-col w-full">
                        <p class="text-white text-base font-medium pb-2">Instructions (one step per line)</p><textarea
                            id="create-recipe-instructions" placeholder="1. Mix flour..."
                            class="form-input w-full rounded-xl text-white bg-[#342118] border-[#684231] min-h-36 p-[15px]"></textarea>
                    </label>
                    <div class="flex gap-4 w-full">
                        <label class="flex flex-col flex-1">
                            <p class="text-white text-base font-medium pb-2">Prep Time</p><input
                                id="create-recipe-prepTime" placeholder="e.g., 15 mins"
                                class="form-input w-full rounded-xl text-white bg-[#342118] border-[#684231] h-14 p-[15px]" />
                        </label>
                        <label class="flex flex-col flex-1">
                            <p class="text-white text-base font-medium pb-2">Cook Time</p><input
                                id="create-recipe-cookTime" placeholder="e.g., 30 mins"
                                class="form-input w-full rounded-xl text-white bg-[#342118] border-[#684231] h-14 p-[15px]" />
                        </label>
                    </div>
                    <label class="flex flex-col w-full">
                        <p class="text-white text-base font-medium pb-2">Servings</p><input id="create-recipe-servings"
                            placeholder="e.g., 4"
                            class="form-input w-full rounded-xl text-white bg-[#342118] border-[#684231] h-14 p-[15px]" />
                    </label>
                    <div
                        class="flex flex-col items-center gap-2 p-4 rounded-xl border-2 border-dashed border-[#684231]">
                        <p class="text-white text-lg font-bold">Upload Photo</p>
                        <input type="file" id="create-recipe-photoInput" accept="image/*"
                            class="text-white text-sm file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-[#492e22] file:text-white hover:file:bg-[#5a3a2a]">
                    </div>
                </div>
                <div class="flex px-4 py-3 mt-4"><button id="save-recipe-button"
                        class="flex w-full cursor-pointer items-center justify-center rounded-xl h-12 px-5 bg-[#f0560e] text-white text-base font-bold"><span
                            class="truncate">Save Recipe</span></button></div>
            </div>
        </div>

        <div id="page-schedule" class="page bg-[#231610] dark group/design-root">
            <div class="page-header">
                <div class="flex items-center p-4 pb-2 justify-between">
                    <div class="text-white flex size-12 shrink-0 items-center cursor-pointer" data-action="back"><svg
                            xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
                            viewBox="0 0 256 256">
                            <path
                                d="M224,128a8,8,0,0,1-8,8H59.31l58.35,58.34a8,8,0,0,1-11.32,11.32l-72-72a8,8,0,0,1,0-11.32l72-72a8,8,0,0,1,11.32,11.32L59.31,120H216A8,8,0,0,1,224,128Z">
                            </path>
                        </svg></div>
                    <h2 class="text-white text-lg font-bold flex-1 text-center pr-12">Meal Planner</h2>
                </div>
            </div>
            <div class="page-content">
                <div class="flex items-center justify-between p-4 sticky top-0 bg-[#231610] z-10">
                    <button id="schedule-prev-week" class="text-white p-2 rounded-full hover:bg-white/10">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M165.66,202.34a8,8,0,0,1-11.32,11.32l-80-80a8,8,0,0,1,0-11.32l80-80a8,8,0,0,1,11.32,11.32L91.31,128Z"></path></svg>
                    </button>
                    <h3 id="schedule-week-range" class="text-white text-lg font-semibold text-center"></h3>
                    <button id="schedule-next-week" class="text-white p-2 rounded-full hover:bg-white/10">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256"><path d="M181.66,133.66l-80,80a8,8,0,0,1-11.32-11.32L164.69,128,90.34,53.66a8,8,0,0,1,11.32-11.32l80,80A8,8,0,0,1,181.66,133.66Z"></path></svg>
                    </button>
                </div>
                <div id="schedule-week-days" class="flex justify-around p-2 border-b border-gray-700 mb-3 sticky top-[72px] bg-[#231610] z-10">
                </div>
                <h2 id="schedule-selected-day-title" class="text-white text-[22px] font-bold px-4 pb-3 pt-2">Meals for Today</h2>
                <div id="schedule-meal-list" class="px-4">
                </div>
                <div class="flex justify-center px-4 py-5">
                    <button id="schedule-open-add-meal-modal-button" class="flex items-center justify-center rounded-xl h-12 px-5 bg-[#f0560e] text-white text-base font-bold gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20px" height="20px" fill="currentColor" viewBox="0 0 256 256"><path d="M224,128a8,8,0,0,1-8,8H136v80a8,8,0,0,1-16,0V136H40a8,8,0,0,1,0-16h80V40a8,8,0,0,1,16,0v80h80A8,8,0,0,1,224,128Z"></path></svg>
                        <span>Add Meal</span>
                    </button>
                </div>
            </div>
            <div id="add-meal-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-[1100] hidden">
                <div class="bg-[#2e241f] p-4 rounded-lg shadow-xl w-11/12 max-w-md max-h-[80vh] flex flex-col">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="text-white text-xl font-bold">Add Recipe to Meal Plan</h3>
                        <button id="add-meal-modal-close-button" class="text-white p-1 hover:bg-white/10 rounded-full">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 256 256"><path d="M205.66,194.34a8,8,0,0,1-11.32,11.32L128,139.31,61.66,205.66a8,8,0,0,1-11.32-11.32L116.69,128,50.34,61.66A8,8,0,0,1,61.66,50.34L128,116.69l66.34-66.35a8,8,0,0,1,11.32,11.32L139.31,128Z"></path></svg>
                        </button>
                    </div>
                    <div class="mb-3">
                        <input type="text" id="add-meal-modal-search" placeholder="Search recipes..." class="form-input w-full rounded-lg text-white bg-[#40322b] border-[#684231] h-12 p-3 placeholder:text-[#bda89e] focus:ring-1 focus:ring-[#f0560e] focus:border-[#f0560e]">
                    </div>
                    <div id="add-meal-modal-recipe-list" class="overflow-y-auto flex-grow space-y-2 pr-1">
                    </div>
                </div>
            </div>
        </div>


        <div id="page-profile" class="page bg-[#1e1815] dark group/design-root">
            <div class="page-header">
                <div class="flex items-center p-4 pb-2 justify-center">
                    <h2 class="text-white text-lg font-bold">Profile</h2>
                </div>
            </div>
            <div class="page-content flex flex-col items-center justify-center">
                <h1 class="text-white text-3xl">Profile Page</h1>
                <p class="text-[#bda89e] mt-4">This is a placeholder.</p>
            </div>
        </div>
    </div>

    <div class="bottom-nav-bar">
        <div class="flex gap-1 px-2 pb-3 pt-2">
            <a class="nav-item just flex flex-1 flex-col items-center justify-end gap-1 rounded-full text-white"
                href="#" data-target="page-index" data-icon-name="BookOpen">
                <div class="nav-icon-container text-white flex h-8 items-center justify-center"><svg
                        xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
                        viewBox="0 0 256 256">
                        <path
                            d="M224,48H160a40,40,0,0,0-32,16A40,40,0,0,0,96,48H32A16,16,0,0,0,16,64V192a16,16,0,0,0,16,16H96a24,24,0,0,1,24,24,8,8,0,0,0,16,0,24,24,0,0,1,24-24h64a16,16,0,0,0,16-16V64A16,16,0,0,0,224,48ZM96,192H32V64H96a24,24,0,0,1,24,24V200A39.81,39.81,0,0,0,96,192Zm128,0H160a39.81,39.81,0,0,0-24,8V88a24,24,0,0,1,24-24h64Z">
                        </path>
                    </svg></div>
                <p class="nav-text text-white text-xs font-medium">Recipes</p>
            </a>
            <a class="nav-item just flex flex-1 flex-col items-center justify-end gap-1 text-[#bda89e]" href="#"
                data-target="page-favorites" data-icon-name="Heart"> 
                <div class="nav-icon-container text-[#bda89e] flex h-8 items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor" viewBox="0 0 256 256">
                        <path d="M240,94c0,70-103.79,126.66-108.21,129a8,8,0,0,1-7.58,0C119.79,220.66,16,164,16,94A62.07,62.07,0,0,1,78,32c20.65,0,38.41,8.88,50,23.89C139.59,40.88,157.35,32,178,32A62.07,62.07,0,0,1,240,94Zm-16,0a46.06,46.06,0,0,0-46-46c-19.45,0-35.78,10.36-42.6,27a8,8,0,0,1-14.8,0C114.78,58.36,98.45,48,79,48a46.06,46.06,0,0,0-46,46c0,51.91,74.22,96.66,91.08,107.18a8,8,0,0,0,7.84,0C148.78,190.66,224,145.91,224,94Z"></path>
                    </svg>
                </div>
                <p class="nav-text text-[#bda89e] text-xs font-medium">Favorites</p>
            </a>
            <a class="nav-item just flex flex-1 flex-col items-center justify-end gap-1 text-[#bda89e]" href="#"
                data-target="page-create-recipe" data-icon-name="PlusSquare">
                <div class="nav-icon-container text-[#bda89e] flex h-8 items-center justify-center"><svg
                        xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
                        viewBox="0 0 256 256">
                        <path
                            d="M208,32H48A16,16,0,0,0,32,48V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V48A16,16,0,0,0,208,32Zm0,176H48V48H208V208Zm-32-80a8,8,0,0,1-8,8H136v32a8,8,0,0,1-16,0V136H88a8,8,0,0,1,0-16h32V88a8,8,0,0,1,16,0v32h32A8,8,0,0,1,176,128Z">
                        </path>
                    </svg></div>
                <p class="nav-text text-[#bda89e] text-xs font-medium">Create</p>
            </a>
            <a class="nav-item just flex flex-1 flex-col items-center justify-end gap-1 text-[#bda89e]" href="#"
                data-target="page-schedule" data-icon-name="Calendar">
                <div class="nav-icon-container text-[#bda89e] flex h-8 items-center justify-center"><svg
                        xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
                        viewBox="0 0 256 256">
                        <path
                            d="M208,32H184V24a8,8,0,0,0-16,0v8H88V24a8,8,0,0,0-16,0v8H48A16,16,0,0,0,32,48V208a16,16,0,0,0,16,16H208a16,16,0,0,0,16-16V48A16,16,0,0,0,208,32ZM72,48v8a8,8,0,0,0,16,0V48h80v8a8,8,0,0,0,16,0V48h24V80H48V48ZM208,208H48V96H208V208Zm-96-88v64a8,8,0,0,1-16,0V132.94l-4.42,2.22a8,8,0,0,1-7.16-14.32l16-8A8,8,0,0,1,112,120Zm59.16,30.45L152,176h16a8,8,0,0,1,0,16H136a8,8,0,0,1-6.4-12.8l28.78-38.37A8,8,0,1,0,145.07,132a8,8,0,1,1-13.85-8A24,24,0,0,1,176,136,23.76,23.76,0,0,1,171.16,150.45Z">
                        </path>
                    </svg></div>
                <p class="nav-text text-[#bda89e] text-xs font-medium">Meal Plan</p>
            </a>
            <a class="nav-item just flex flex-1 flex-col items-center justify-end gap-1 text-[#bda89e]" href="#"
                data-target="page-profile" data-icon-name="User">
                <div class="nav-icon-container text-[#bda89e] flex h-8 items-center justify-center"><svg
                        xmlns="http://www.w3.org/2000/svg" width="24px" height="24px" fill="currentColor"
                        viewBox="0 0 256 256">
                        <path
                            d="M230.92,212c-15.23-26.33-38.7-45.21-66.09-54.16a72,72,0,1,0-73.66,0C63.78,166.78,40.31,185.66,25.08,212a8,8,0,1,0,13.85,8c18.84-32.56,52.14-52,89.07-52s70.23,19.44,89.07,52a8,8,0,1,0,13.85-8ZM72,96a56,56,0,1,1,56,56A56.06,56.06,0,0,1,72,96Z">
                        </path>
                    </svg></div>
                <p class="nav-text text-[#bda89e] text-xs font-medium">Profile</p>
            </a>
        </div>
    </div>

    <script>
        // --- Global App Variables ---
        let currentPageId = 'page-index';
        let previousPageId = 'page-index'; 
        let allRecipesCache = [];
        let editingRecipeId = null; 
        let currentRecipeImageURL = null; 
        let currentSelectedDate = new Date(); 
        let currentDisplayedWeekStartDate = getStartOfWeek(new Date()); 

        // --- Date Helper Functions ---
        function getStartOfWeek(date, startDay = 0) { 
            const d = new Date(date); const day = d.getDay(); 
            const diff = (day < startDay ? day + 7 : day) - startDay;
            d.setDate(d.getDate() - diff); d.setHours(0, 0, 0, 0); return d;
        }
        function addDays(date, days) {
            const result = new Date(date); result.setDate(result.getDate() + days); return result;
        }
        function formatDateForDisplay(date) { 
            if (isToday(date)) return "Today";
            if (isSameDate(date, addDays(new Date(), 1))) return "Tomorrow";
            return date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
        }
        function formatDateForFirebaseKey(date) { 
            const year = date.getFullYear(); const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0'); return `${year}-${month}-${day}`;
        }
        function isSameDate(date1, date2) {
            if (!date1 || !date2) return false;
            return date1.getFullYear() === date2.getFullYear() && date1.getMonth() === date2.getMonth() && date1.getDate() === date2.getDate();
        }
        function isToday(date) { return isSameDate(date, new Date()); }

        // --- Debounce Utility ---
        function debounce(func, delay) {
            let timeout;
            return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), delay); };
        }

        // --- Navigation and Page Display ---
        function showPage(pageId, fromBackButton = false) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const targetPage = document.getElementById(pageId);
            if (targetPage) {
                if (!fromBackButton && currentPageId !== pageId) {
                    previousPageId = currentPageId;
                }
                targetPage.classList.add('active');
                currentPageId = pageId;
                updateNavbarUI(pageId);
                const activePageContent = targetPage.querySelector('.page-content');
                if (activePageContent) activePageContent.scrollTop = 0;

                if (pageId === 'page-index') {
                    const searchInput = document.getElementById('search-recipe-input');
                    if (searchInput && searchInput.value.trim() === '') handleSearch(); 
                } else if (pageId === 'page-favorites') {
                    renderFavoritesPage();
                } else if (pageId === 'page-schedule') {
                    if (!fromBackButton || previousPageId !== 'page-recipe') { 
                        currentSelectedDate = new Date(); currentDisplayedWeekStartDate = getStartOfWeek(new Date()); 
                    }
                    renderWeekView(); 
                }
            } else { showPage('page-index'); }
        }

        function updateNavbarUI(activePageId) {
            document.querySelectorAll('.nav-item').forEach(item => {
                const target = item.dataset.target;
                let isEffectivelyActive = (target === activePageId);

                if (activePageId === 'page-recipe') {
                    if (target === previousPageId && (previousPageId === 'page-index' || previousPageId === 'page-favorites')) {
                        isEffectivelyActive = true;
                    } else if (target === 'page-index' && previousPageId !== 'page-favorites') { 
                         isEffectivelyActive = true;
                    }
                }
                
                const textColor = isEffectivelyActive ? 'text-white' : 'text-[#bda89e]';
                const iconContainer = item.querySelector('.nav-icon-container');
                const textElement = item.querySelector('.nav-text');

                ['text-white', 'text-[#bda89e]'].forEach(cls => { 
                    item.classList.remove(cls); 
                    if (textElement) textElement.classList.remove(cls);
                    if (iconContainer) iconContainer.classList.remove(cls);
                });
                item.classList.add(textColor); 
                if (textElement) textElement.classList.add(textColor);
                if (iconContainer) iconContainer.classList.add(textColor);

                if (target === 'page-favorites' && iconContainer) {
                    const heartSVG = iconContainer.querySelector('svg');
                    if (heartSVG) {
                        heartSVG.innerHTML = isEffectivelyActive 
                            ? `<path d="M178,32c-20.65,0-38.41,8.88-50,23.89C116.41,40.88,98.65,32,78,32A62.07,62.07,0,0,0,16,94c0,70,103.79,126.66,108.21,129a8,8,0,0,0,7.58,0C136.21,220.66,240,164,240,94A62.07,62.07,0,0,0,178,32Z"></path>`
                            : `<path d="M240,94c0,70-103.79,126.66-108.21,129a8,8,0,0,1-7.58,0C119.79,220.66,16,164,16,94A62.07,62.07,0,0,1,78,32c20.65,0,38.41,8.88,50,23.89C139.59,40.88,157.35,32,178,32A62.07,62.07,0,0,1,240,94Zm-16,0a46.06,46.06,0,0,0-46-46c-19.45,0-35.78,10.36-42.6,27a8,8,0,0,1-14.8,0C114.78,58.36,98.45,48,79,48a46.06,46.06,0,0,0-46,46c0,51.91,74.22,96.66,91.08,107.18a8,8,0,0,0,7.84,0C148.78,190.66,224,145.91,224,94Z"></path>`;
                    }
                }
            });
        }

        // --- Recipe CRUD and Display (Using Realtime Database) ---
        async function loadRecipesFromRealtimeDB() {
            try {
                const snapshot = await database.ref('recipes').orderByChild('createdAt').once('value');
                allRecipesCache = [];
                if (snapshot.exists()) {
                    const recipesData = snapshot.val();
                    allRecipesCache = Object.keys(recipesData).map(key => ({ id: key, ...recipesData[key] }))
                        .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0)); 
                }
                if (currentPageId === 'page-index') {
                    const searchInput = document.getElementById('search-recipe-input');
                    if (searchInput && searchInput.value.trim() !== '') handleSearch(); 
                    else populateRecipeListsUI(allRecipesCache, false); 
                } else if (currentPageId === 'page-favorites') {
                    renderFavoritesPage(); 
                }
            } catch (error) { console.error("Error fetching recipes from RTDB: ", error); alert("Could not load recipes."); }
        }

        function populateRecipeListsUI(recipes, isSearchMode = false) {
            const featuredContainer = document.getElementById('featured-recipes-container');
            const quickEasyContainer = document.getElementById('quick-easy-recipes-container');
            const recentlyAddedHeading = document.getElementById('recently-added-heading');
            const allRecipesHeading = document.getElementById('all-recipes-heading');

            featuredContainer.innerHTML = ''; quickEasyContainer.innerHTML = '';

            if (isSearchMode) {
                recentlyAddedHeading.style.display = 'none'; allRecipesHeading.style.display = 'none';
                featuredContainer.style.display = 'none';
                if (recipes.length === 0) quickEasyContainer.innerHTML = '<p class="text-center text-[#cba390] py-4 col-span-full w-full">No recipes found matching your search.</p>';
                else recipes.forEach(recipe => quickEasyContainer.innerHTML += createRecipeCardHtml(recipe));
            } else { 
                recentlyAddedHeading.style.display = 'block'; allRecipesHeading.style.display = 'block';
                featuredContainer.style.display = 'flex';
                if (recipes.length === 0) {
                    const noMsg = '<p class="text-center text-[#cba390] py-4 px-4 w-full col-span-full">No recipes added yet. Create one!</p>';
                    featuredContainer.innerHTML = noMsg; quickEasyContainer.innerHTML = noMsg; 
                } else {
                    recipes.forEach((recipe, index) => {
                        if (index < 5 && recipes.length > 3) featuredContainer.innerHTML += createRecipeCardHtml(recipe, true);
                        else if (recipes.length <=3 && index < recipes.length ) featuredContainer.innerHTML += createRecipeCardHtml(recipe, true);
                        quickEasyContainer.innerHTML += createRecipeCardHtml(recipe, false);
                    });
                     if (featuredContainer.innerHTML === '' && recipes.length > 0) recentlyAddedHeading.style.display = 'none';
                }
            }
            attachRecipeCardListeners();
        }

        function createRecipeCardHtml(recipe, isFeatured = false) {
            const descSnippet = (recipe.description || 'No description.').substring(0, 70) + ((recipe.description || '').length > 70 ? '...' : '');
            const imageStyle = `style='background-image: url("${recipe.imageURL || 'https://via.placeholder.com/300x200.png?text=No+Image'}");'`;
            if (isFeatured) return `<div class="flex h-full flex-1 flex-col gap-4 rounded-lg min-w-60 cursor-pointer" data-recipe-id="${recipe.id}"><div class="w-full bg-center bg-no-repeat aspect-video bg-cover rounded-xl" ${imageStyle}></div><div><p class="text-white text-base font-medium">${recipe.title || 'Untitled'}</p><p class="text-[#bda89e] text-sm">${descSnippet}</p></div></div>`;
            else return `<div class="flex flex-col gap-3 pb-3 cursor-pointer" data-recipe-id="${recipe.id}"><div class="w-full bg-center bg-no-repeat aspect-square bg-cover rounded-xl" ${imageStyle}></div><div><p class="text-white text-base font-medium">${recipe.title || 'Untitled'}</p><p class="text-[#bda89e] text-sm">${descSnippet}</p></div></div>`;
        }

        function handleSearch() {
            const searchInput = document.getElementById('search-recipe-input'); if (!searchInput) return; 
            const searchTerm = searchInput.value.trim().toLowerCase();
            if (searchTerm === "") populateRecipeListsUI(allRecipesCache, false); 
            else {
                const filtered = allRecipesCache.filter(r => (r.title||'').toLowerCase().includes(searchTerm) || (r.description||'').toLowerCase().includes(searchTerm));
                populateRecipeListsUI(filtered, true); 
            }
        }
        
        // --- Favorites Page Logic ---
        function renderFavoritesPage() {
            const searchInput = document.getElementById('search-favorites-input');
            const searchTerm = searchInput ? searchInput.value.trim().toLowerCase() : "";
            let bookmarkedRecipes = allRecipesCache.filter(r => r.isBookmarked);
            if (searchTerm !== "") {
                bookmarkedRecipes = bookmarkedRecipes.filter(r => (r.title||'').toLowerCase().includes(searchTerm) || (r.description||'').toLowerCase().includes(searchTerm));
            }
            populateFavoritesListUI(bookmarkedRecipes, searchTerm !== "");
        }
        function populateFavoritesListUI(bookmarkedRecipes, isSearchMode = false) {
            const container = document.getElementById('favorites-recipes-container'); container.innerHTML = '';
            if (bookmarkedRecipes.length === 0) {
                const message = isSearchMode ? '<p class="text-center text-[#cba390] py-4 col-span-full w-full">No favorite recipes found matching your search.</p>' : '<p class="text-center text-[#cba390] py-4 col-span-full w-full">No favorite recipes yet. Bookmark some!</p>';
                container.innerHTML = message;
            } else bookmarkedRecipes.forEach(recipe => container.innerHTML += createRecipeCardHtml(recipe, false));
            attachRecipeCardListeners();
        }
        function handleFavoritesSearch() { renderFavoritesPage(); }

        function attachRecipeCardListeners() {
            document.querySelectorAll('[data-recipe-id]').forEach(card => { card.removeEventListener('click', handleRecipeCardClick); card.addEventListener('click', handleRecipeCardClick); });
        }
        function handleRecipeCardClick(event) {
            const recipeId = event.currentTarget.dataset.recipeId; if (recipeId) loadRecipeDetailFromRealtimeDB(recipeId);
        }
        async function loadRecipeDetailFromRealtimeDB(recipeId) {
            try {
                const snapshot = await database.ref(`recipes/${recipeId}`).once('value');
                if (snapshot.exists()) { displayRecipeDetailsUI({ id: recipeId, ...snapshot.val() }); showPage('page-recipe'); }
                else { alert("Recipe not found."); showPage(previousPageId || 'page-index', true); }
            } catch (error) { console.error("Error getting recipe from RTDB:", error); }
        }
        function displayRecipeDetailsUI(recipe) {
            document.getElementById('page-recipe').dataset.currentRecipeId = recipe.id; 
            document.getElementById('recipe-image').style.backgroundImage = `url("${recipe.imageURL || 'https://via.placeholder.com/300x200.png?text=No+Image'}")`;
            document.getElementById('recipe-title').textContent = recipe.title || 'Untitled'; 
            document.getElementById('recipe-description').textContent = recipe.description || 'No description.';
            const ingredientsList = document.getElementById('recipe-ingredients-list'); ingredientsList.innerHTML = ''; (recipe.ingredients || []).forEach(ing => ingredientsList.innerHTML += `<label class="flex gap-x-3 py-3 items-center"><input type="checkbox" class="form-checkbox-custom"/><p class="text-white text-base">${ing}</p></label>`);
            const instructionsList = document.getElementById('recipe-instructions-list'); instructionsList.innerHTML = ''; (recipe.instructions || []).forEach(step => instructionsList.innerHTML += `<div class="flex items-center min-h-14 py-1"><p class="text-white text-base flex-1">${step}</p></div>`);
            
            const bmIcon = document.getElementById('recipe-bookmark-icon');
            bmIcon.innerHTML = recipe.isBookmarked ? `<path d="M184,32H72A16,16,0,0,0,56,48V224a8,8,0,0,0,12.24,6.78L128,193.43l59.77,37.35A8,8,0,0,0,200,224V48A16,16,0,0,0,184,32Z"></path>` : `<path d="M184,32H72A16,16,0,0,0,56,48V224a8,8,0,0,0,12.24,6.78L128,193.43l59.77,37.35A8,8,0,0,0,200,224V48A16,16,0,0,0,184,32Zm0,177.57-51.77-32.35a8,8,0,0,0-8.48,0L72,209.57V48H184Z"></path>`;
            bmIcon.classList.toggle('text-[#f0560e]', !!recipe.isBookmarked); bmIcon.classList.toggle('text-white', !recipe.isBookmarked);
            document.getElementById('recipe-bookmark-button').dataset.recipeId = recipe.id;
            document.getElementById('delete-recipe-button').dataset.recipeId = recipe.id; 
            document.getElementById('delete-recipe-button').dataset.imageURL = recipe.imageURL || '';
        }

        function resetCreateForm() {
            document.getElementById('create-recipe-title').value = ''; document.getElementById('create-recipe-description').value = '';
            document.getElementById('create-recipe-ingredients').value = ''; document.getElementById('create-recipe-instructions').value = '';
            document.getElementById('create-recipe-prepTime').value = ''; document.getElementById('create-recipe-cookTime').value = '';
            document.getElementById('create-recipe-servings').value = ''; document.getElementById('create-recipe-photoInput').value = ''; 
            document.querySelector('#page-create-recipe .page-header h2').textContent = 'New Recipe';
            editingRecipeId = null; currentRecipeImageURL = null;
        }

        async function prepareEditForm(recipeIdToEdit) {
            const recipeRef = database.ref(`recipes/${recipeIdToEdit}`);
            try {
                const snapshot = await recipeRef.once('value');
                if (snapshot.exists()) {
                    const r = snapshot.val(); editingRecipeId = recipeIdToEdit; currentRecipeImageURL = r.imageURL || '';
                    document.querySelector('#page-create-recipe .page-header h2').textContent = 'Edit Recipe';
                    document.getElementById('create-recipe-title').value = r.title || '';
                    document.getElementById('create-recipe-description').value = r.description || '';
                    document.getElementById('create-recipe-ingredients').value = (r.ingredients || []).join('\n');
                    document.getElementById('create-recipe-instructions').value = (r.instructions || []).join('\n');
                    document.getElementById('create-recipe-prepTime').value = r.prepTime || '';
                    document.getElementById('create-recipe-cookTime').value = r.cookTime || '';
                    document.getElementById('create-recipe-servings').value = r.servings || '';
                    document.getElementById('create-recipe-photoInput').value = ''; 
                    showPage('page-create-recipe');
                } else { alert("Recipe not found for editing."); resetCreateForm(); }
            } catch (error) { console.error("Error fetching recipe for edit:", error); alert("Could not load recipe for editing."); resetCreateForm(); }
        }

        async function saveRecipeData() {
            const title = document.getElementById('create-recipe-title').value.trim(); if (!title) { alert("Recipe title is required."); return; }
            const description = document.getElementById('create-recipe-description').value.trim();
            const ingredients = document.getElementById('create-recipe-ingredients').value.split('\n').map(s => s.trim()).filter(s => s);
            const instructions = document.getElementById('create-recipe-instructions').value.split('\n').map(s => s.trim()).filter(s => s);
            const prepTime = document.getElementById('create-recipe-prepTime').value.trim(); const cookTime = document.getElementById('create-recipe-cookTime').value.trim();
            const servings = document.getElementById('create-recipe-servings').value.trim(); const imageFileInput = document.getElementById('create-recipe-photoInput');
            const saveBtn = document.getElementById('save-recipe-button'); saveBtn.textContent = "Saving..."; saveBtn.disabled = true;
            let imageURL = editingRecipeId ? currentRecipeImageURL : '';

            try {
                if (imageFileInput.files[0]) {
                    const file = imageFileInput.files[0]; const formData = new FormData();
                    formData.append('file', file); formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                    const response = await fetch(CLOUDINARY_UPLOAD_URL, { method: 'POST', body: formData });
                    const data = await response.json();
                    if (data.secure_url) imageURL = data.secure_url;
                    else throw new Error(data.error?.message || 'Cloudinary upload failed');
                }
                const recipeData = { title, description, ingredients, instructions, prepTime, cookTime, servings, imageURL, isBookmarked: editingRecipeId ? (allRecipesCache.find(r => r.id === editingRecipeId)?.isBookmarked || false) : false };
                if (editingRecipeId) {
                    const snap = await database.ref(`recipes/${editingRecipeId}/createdAt`).once('value');
                    recipeData.createdAt = snap.exists() ? snap.val() : serverTimestamp; 
                    recipeData.updatedAt = serverTimestamp;
                    await database.ref(`recipes/${editingRecipeId}`).update(recipeData); alert("Recipe updated successfully!");
                } else {
                    recipeData.createdAt = serverTimestamp;
                    await database.ref('recipes').push().set(recipeData); alert("Recipe saved successfully!");
                }
                resetCreateForm(); await loadRecipesFromRealtimeDB(); showPage('page-index');
            } catch (error) { console.error("Error saving recipe: ", error); alert("Failed to save recipe: " + error.message); } 
            finally { saveBtn.textContent = "Save Recipe"; saveBtn.disabled = false; }
        }

        async function deleteRecipeFromRealtimeDB(recipeId, imageURL) {
            if (!confirm("Are you sure you want to delete this recipe?")) return;
            try {
                await database.ref(`recipes/${recipeId}`).remove(); alert("Recipe deleted from database."); 
                await loadRecipesFromRealtimeDB(); showPage(previousPageId || 'page-index', true);
            } catch (error) { console.error("Error deleting recipe from RTDB:", error); alert("Failed to delete recipe."); }
        }
        async function toggleBookmarkInRealtimeDB(recipeId) {
            const recipeRef = database.ref(`recipes/${recipeId}`);
            try {
                const snapshot = await recipeRef.once('value'); 
                if (snapshot.exists()) { 
                    const newIsBookmarked = !snapshot.val().isBookmarked;
                    await recipeRef.update({ isBookmarked: newIsBookmarked }); 
                    const bmIcon = document.getElementById('recipe-bookmark-icon');
                    bmIcon.innerHTML = newIsBookmarked ? `<path d="M184,32H72A16,16,0,0,0,56,48V224a8,8,0,0,0,12.24,6.78L128,193.43l59.77,37.35A8,8,0,0,0,200,224V48A16,16,0,0,0,184,32Z"></path>` : `<path d="M184,32H72A16,16,0,0,0,56,48V224a8,8,0,0,0,12.24,6.78L128,193.43l59.77,37.35A8,8,0,0,0,200,224V48A16,16,0,0,0,184,32Zm0,177.57-51.77-32.35a8,8,0,0,0-8.48,0L72,209.57V48H184Z"></path>`;
                    bmIcon.classList.toggle('text-[#f0560e]', newIsBookmarked); bmIcon.classList.toggle('text-white', !newIsBookmarked);
                    const cachedRecipe = allRecipesCache.find(r => r.id === recipeId); if (cachedRecipe) cachedRecipe.isBookmarked = newIsBookmarked; 
                    if (currentPageId === 'page-favorites' && !newIsBookmarked) renderFavoritesPage();
                }
            } catch (error) { console.error("Error toggling bookmark in RTDB:", error); }
        }

        // --- Meal Planning ---
        function renderWeekView() {
            const weekDaysContainer = document.getElementById('schedule-week-days'); const weekRangeEl = document.getElementById('schedule-week-range');
            if (!weekDaysContainer || !weekRangeEl) return; weekDaysContainer.innerHTML = '';
            const dayFmtShort = new Intl.DateTimeFormat('en-US', { weekday: 'short' }); const dayFmtNum = new Intl.DateTimeFormat('en-US', { day: 'numeric' });
            let tempDate = new Date(currentDisplayedWeekStartDate);
            for (let i = 0; i < 7; i++) {
                const btn = document.createElement('button'); btn.className = 'schedule-day-btn flex flex-col items-center p-1.5 fo w-[calc(100%/7-4px)] mx-0.5';
                btn.dataset.date = tempDate.toISOString();
                const isTodayFlg = isToday(tempDate); const isSelectedFlg = isSameDate(tempDate, currentSelectedDate);
                btn.innerHTML = `<span class="day-name-span text-xs ${isTodayFlg && !isSelectedFlg ? 'text-[#f0560e]' : 'text-gray-400'}">${dayFmtShort.format(tempDate).toUpperCase()}</span><span class="day-number-span text-lg font-bold ${isTodayFlg && !isSelectedFlg ? 'text-[#f0560e]' : 'text-white'}">${dayFmtNum.format(tempDate)}</span>`;
                if (isSelectedFlg) btn.classList.add('selected'); if (isTodayFlg) btn.classList.add('today');
                btn.addEventListener('click', handleWeekDayClick); weekDaysContainer.appendChild(btn); tempDate = addDays(tempDate, 1);
            }
            weekRangeEl.textContent = `${currentDisplayedWeekStartDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} - ${addDays(currentDisplayedWeekStartDate, 6).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}`;
            loadMealsForSelectedDate();
        }
        function handleWeekDayClick(event) { currentSelectedDate = new Date(event.currentTarget.dataset.date); renderWeekView(); }
        function navigateToPreviousWeek() { currentDisplayedWeekStartDate = addDays(currentDisplayedWeekStartDate, -7); currentSelectedDate = new Date(currentDisplayedWeekStartDate); renderWeekView(); }
        function navigateToNextWeek() { currentDisplayedWeekStartDate = addDays(currentDisplayedWeekStartDate, 7); currentSelectedDate = new Date(currentDisplayedWeekStartDate); renderWeekView(); }
        function loadMealsForSelectedDate() {
            const titleEl = document.getElementById('schedule-selected-day-title'); if (!titleEl) return;
            titleEl.textContent = `Meals for ${formatDateForDisplay(currentSelectedDate)}`;
            loadMealPlanForDateFromRealtimeDB(formatDateForFirebaseKey(currentSelectedDate));
        }
        async function loadMealPlanForDateFromRealtimeDB(dateString) {
            const mealListContainer = document.getElementById('schedule-meal-list'); if (!mealListContainer) return;
            mealListContainer.innerHTML = '<p class="text-center text-[#cba390] py-4">Loading meals...</p>';
            try {
                const snapshot = await database.ref(`mealPlan/${dateString}`).once('value');
                displayPlannedMealsUI(snapshot.exists() ? snapshot.val() : {}, dateString);
            } catch (error) { console.error("Error fetching meal plan:", error); mealListContainer.innerHTML = '<p class="text-center text-red-500 py-4">Error loading meals.</p>'; }
        }
        function displayPlannedMealsUI(mealsData, dateString) {
            const mealListContainer = document.getElementById('schedule-meal-list'); if (!mealListContainer) return; mealListContainer.innerHTML = ''; 
            if (Object.keys(mealsData).length === 0) { mealListContainer.innerHTML = '<p class="text-center text-[#cba390] py-4">No meals planned.</p>'; return; }
            Object.entries(mealsData).forEach(([mealPlanEntryId, meal]) => {
                const rDetails = allRecipesCache.find(r => r.id === meal.recipeId);
                const imgUrl = rDetails?.imageURL || 'https://via.placeholder.com/100x100.png?text=No+Img'; const cookTime = rDetails?.cookTime || 'N/A';
                const mealDiv = document.createElement('div'); mealDiv.className = "flex items-center justify-between gap-4 p-2 mb-2 bg-[#40322b] rounded-lg";
                mealDiv.dataset.recipeId = meal.recipeId; mealDiv.dataset.mealPlanEntryId = mealPlanEntryId;
                mealDiv.innerHTML = `<div class="flex items-center gap-3 flex-grow cursor-pointer" data-action="view-recipe-from-plan"><div class="bg-center bg-no-repeat aspect-square bg-cover rounded-md size-14 shrink-0" style='background-image: url("${imgUrl}");'></div><div><p class="text-white text-base font-medium">${meal.recipeTitle || 'Unknown'}</p><p class="text-[#cba390] text-sm">Cook: ${cookTime}</p></div></div><button class="remove-meal-button text-red-400 hover:text-red-600 p-2 rounded-full hover:bg-white/10" title="Remove"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 256 256"><path d="M216,48H176V40a24,24,0,0,0-24-24H104A24,24,0,0,0,80,40v8H40a8,8,0,0,0,0,16h8V208a16,16,0,0,0,16,16H192a16,16,0,0,0,16-16V64h8a8,8,0,0,0,0-16ZM96,40a8,8,0,0,1,8-8h48a8,8,0,0,1,8,8v8H96Zm96,168H64V64H192ZM112,104v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Zm48,0v64a8,8,0,0,1-16,0V104a8,8,0,0,1,16,0Z"></path></svg></button>`;
                mealListContainer.appendChild(mealDiv);
                mealDiv.querySelector('.remove-meal-button').addEventListener('click', (e) => { e.stopPropagation(); handleRemoveMealClick(dateString, mealPlanEntryId); });
                mealDiv.querySelector('[data-action="view-recipe-from-plan"]').addEventListener('click', () => { if (mealDiv.dataset.recipeId) loadRecipeDetailFromRealtimeDB(mealDiv.dataset.recipeId); });
            });
        }
        async function handleRemoveMealClick(dateString, mealPlanEntryId) {
            if (!confirm("Remove this meal from the plan?")) return;
            try { await database.ref(`mealPlan/${dateString}/${mealPlanEntryId}`).remove(); loadMealsForSelectedDate(); } 
            catch (error) { console.error("Error removing meal:", error); alert("Failed to remove meal.");}
        }

        // --- Add Meal Modal ---
        const addMealModal = document.getElementById('add-meal-modal'); const addMealModalRecipeList = document.getElementById('add-meal-modal-recipe-list');
        const addMealModalSearchInput = document.getElementById('add-meal-modal-search');
        function openAddMealModal() {
            if (!addMealModal || !addMealModalSearchInput) return; populateAddMealModalRecipeList(allRecipesCache);
            addMealModalSearchInput.value = ''; addMealModal.classList.remove('hidden');
        }
        function closeAddMealModal() { if (addMealModal) addMealModal.classList.add('hidden'); }
        function populateAddMealModalRecipeList(recipesToDisplay) {
            if (!addMealModalRecipeList) return; addMealModalRecipeList.innerHTML = '';
            if (recipesToDisplay.length === 0) { addMealModalRecipeList.innerHTML = '<p class="text-center text-[#bda89e] py-3">No recipes.</p>'; return; }
            recipesToDisplay.forEach(recipe => {
                const itemDiv = document.createElement('div'); itemDiv.className = "add-meal-recipe-item flex items-center p-2 bg-[#40322b] rounded-lg cursor-pointer hover:bg-[#5a3a2a]";
                itemDiv.dataset.recipeId = recipe.id; itemDiv.dataset.recipeTitle = recipe.title;
                const imgUrl = recipe.imageURL || 'https://via.placeholder.com/50x50.png?text=No+Img';
                itemDiv.innerHTML = `<img src="${imgUrl}" alt="${recipe.title}" class="w-12 h-12 rounded-md mr-3 object-cover shrink-0"><span class="text-white flex-grow truncate" title="${recipe.title}">${recipe.title||'Untitled'}</span><button class="add-this-recipe-button bg-[#f0560e] text-white text-xs px-3 py-1.5 rounded-md ml-2 shrink-0 hover:bg-orange-600">Add</button>`;
                const addBtn = itemDiv.querySelector('.add-this-recipe-button');
                if(addBtn) addBtn.addEventListener('click', (e) => { e.stopPropagation(); handleAddRecipeToPlan(recipe.id, recipe.title); });
                itemDiv.addEventListener('click', () => handleAddRecipeToPlan(recipe.id, recipe.title));
                addMealModalRecipeList.appendChild(itemDiv);
            });
        }
        function handleAddMealModalSearch() {
            if (!addMealModalSearchInput) return; const searchTerm = addMealModalSearchInput.value.trim().toLowerCase();
            if (searchTerm === "") populateAddMealModalRecipeList(allRecipesCache);
            else { const filtered = allRecipesCache.filter(r => (r.title||'').toLowerCase().includes(searchTerm) || (r.description||'').toLowerCase().includes(searchTerm)); populateAddMealModalRecipeList(filtered); }
        }
        async function handleAddRecipeToPlan(recipeId, recipeTitle) {
            const dateStr = formatDateForFirebaseKey(currentSelectedDate);
            try { await database.ref(`mealPlan/${dateStr}`).push({ recipeId, recipeTitle }); closeAddMealModal(); loadMealsForSelectedDate(); } 
            catch (error) { console.error("Error adding to meal plan:", error); alert("Failed to add recipe to plan.");}
        }

        // --- Event Listeners Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            showPage('page-index'); loadRecipesFromRealtimeDB(); 

            document.getElementById('search-recipe-input')?.addEventListener('input', debounce(handleSearch, 300));
            document.getElementById('search-favorites-input')?.addEventListener('input', debounce(handleFavoritesSearch, 300));
            
            document.querySelectorAll('.nav-item').forEach(item => item.addEventListener('click', (e) => {
                e.preventDefault(); const targetPageId = item.dataset.target;
                if (targetPageId === 'page-create-recipe') resetCreateForm(); 
                showPage(targetPageId);
            }));

            document.querySelectorAll('[data-action="back"]').forEach(btn => btn.addEventListener('click', () => {
                let targetBackPage = previousPageId || 'page-index';
                if (currentPageId === 'page-favorites' || currentPageId === 'page-schedule') {
                    targetBackPage = 'page-index'; // Always go to index from these pages' main back button
                }
                showPage(targetBackPage, true);
            }));
            document.querySelector('[data-action="back-from-create"]')?.addEventListener('click', () => {
                resetCreateForm(); showPage(previousPageId || 'page-index', true);
            });

            document.getElementById('save-recipe-button')?.addEventListener('click', saveRecipeData);
            document.getElementById('recipe-bookmark-button')?.addEventListener('click', (e) => { if (e.currentTarget.dataset.recipeId) toggleBookmarkInRealtimeDB(e.currentTarget.dataset.recipeId); });
            document.getElementById('delete-recipe-button')?.addEventListener('click', (e) => { if (e.currentTarget.dataset.recipeId) deleteRecipeFromRealtimeDB(e.currentTarget.dataset.recipeId, e.currentTarget.dataset.imageURL); });
            document.getElementById('recipe-edit-button')?.addEventListener('click', () => {
                const recipeId = document.getElementById('page-recipe').dataset.currentRecipeId;
                if (recipeId) prepareEditForm(recipeId); else { alert("Could not initiate edit."); }
            });

            document.getElementById('schedule-prev-week')?.addEventListener('click', navigateToPreviousWeek);
            document.getElementById('schedule-next-week')?.addEventListener('click', navigateToNextWeek);
            document.getElementById('schedule-open-add-meal-modal-button')?.addEventListener('click', openAddMealModal);
            document.getElementById('add-meal-modal-close-button')?.addEventListener('click', closeAddMealModal);
            if(addMealModalSearchInput) addMealModalSearchInput.addEventListener('input', debounce(handleAddMealModalSearch, 300));
        });
    </script>

    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => { navigator.serviceWorker.register('/cookbook_bare/sw.js', { scope: '/cookbook_bare/' }).then(reg => console.log('SW registered!', reg.scope)).catch(err => console.log('SW registration failed: ', err)); });
        }
    </script>
</body>

</html>